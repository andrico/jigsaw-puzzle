var jigsawPuzzle=function(e){"use strict";const t=(...e)=>t=>[...e].reduce(((e,t)=>t(e)),t),o=e=>t=>(e(t),t),n=(e,t,o)=>{const n=o;return t.addEventListener(e,o),{remove:()=>t.removeEventListener(e,n)}},c=e=>({scroll:e=>n("scroll",window,e),resize:e=>n("resize",window,e),click:t=>n("click",e.element,t),mousedown:t=>n("mousedown",e.element,t),mousemove:t=>n("mousemove",e.element,t),mouseup:e=>n("mouseup",document.body,e)}),s=e=>t=>t[e],i=(e,t)=>o=>o[e]===t,a=(e,t,o)=>{const n=e+1;return(e=>{let t={};return Object.keys(e).forEach((o=>{null!==e[o]&&(t[o]=e[o])})),t})({top:n>o?e-o:null,right:n%o!=0?e+1:null,bottom:n<=(t-1)*o?e+o:null,left:n%o!=1?e-1:null})},r=["top","right","bottom","left"],l=e=>"top"===e||"bottom"===e,h=(e=100,t=100)=>{const o=t/110,n=e/2;return[{cx1:0,cy1:0,cx2:n-10*o,cy2:5*o,ex:n-13*o,ey:0*o},{cx1:n-13*o,cy1:0*o,cx2:n-10*o,cy2:-2*o,ex:n-12*o,ey:-5*o},{cx1:n-12*o,cy1:-5*o,cx2:n-30*o,cy2:-30*o,ex:n,ey:-30*o},{cx1:n,cy1:-30*o,cx2:n- -30*o,cy2:-31*o,ex:n- -12*o,ey:-5*o},{cx1:n- -12*o,cy1:-5*o,cx2:n- -10*o,cy2:-2*o,ex:n- -13*o,ey:0*o},{cx1:n- -13*o,cy1:0*o,cx2:n- -10*o,cy2:5*o,ex:e,ey:0*o}]},d=(e,t=1)=>e.map(((e,o)=>({cx1:e.cx1*t,cy1:-1*e.cy1,cx2:e.cx2*t,cy2:-1*e.cy2,ex:e.ex*t,ey:-1*e.ey}))),u=(e=Math.random())=>.5*(Math.cos(6669.1337*Math.sin(1337.1337*(e+69)))+1),p=(e,t)=>{const o=t=>e.find((e=>e.id===t)),n=(e,t)=>o(e)&&o(e).shapes&&o(e).shapes[(e=>({top:"bottom",right:"left",bottom:"top",left:"right"}[e]))(t)],c={...(({neighbors:e,width:t,height:o})=>Object.keys(e).reduce(((c,s)=>({[s]:n(e[s],s)?d(n(e[s],s)):u()>=.5?h(l(s)?t:o,Math.min(t,o)):d(h(l(s)?t:o,Math.min(t,o))),...c})),{}))(t),...(({neighbors:e})=>r.filter((t=>!Object.keys(e).includes(t))).reduce(((e,t)=>({[t]:"flat",...e})),{}))(t)};return[{...t,shapes:c},...e]};function g(e){const t=[...e];let o=t.length;for(;o>0;){let e=Math.floor(Math.random()*o);o--;let n=t[o];t[o]=t[e],t[e]=n}return t}const y=e=>({...e,pieces:e.puzzle.aligned?g(e.pieces).map(((t,o)=>({...t,connections:[],curPos:{x:o%e.puzzle.cols*e.pieces[0].width*1.5,y:Math.floor(o/e.puzzle.cols)*e.pieces[0].height*1.5}}))):e.pieces.map(((t,o)=>({...t,connections:[],curPos:{x:u()*(e.canvas.width-e.pieces[0].width),y:u()*(e.canvas.height-e.pieces[0].height)}})))}),m=e=>[...new Set(e)],f=(e,t)=>t.active?-1:1,x=e=>t=>t.reduceRight(((t,o,n,c)=>[...t,e(o,n,c,t)]),[]),v=(e,t)=>o=>{const{image:n}=e.image,{ctx:c,DPI:s=2}=t||e.canvas,{scale:i,occupy:a}=e.puzzle,l=Math.max(o.width,o.height);c.save(),c.beginPath(),c.translate(o.curPos.x,o.curPos.y+o.height),r.forEach((e=>{!function(e,t,o){e.translate(0,o.x),"flat"===t?e.lineTo(o.y,0):t.forEach((t=>{e.bezierCurveTo(t.cx1,t.cy1,t.cx2,t.cy2,t.ex,t.ey)}));e.rotate(Math.PI/2)}(c,o.shapes[e],{x:"top"===e||"bottom"===e?-o.height:-o.width,y:"top"===e||"bottom"===e?o.width:o.height})})),c.closePath(),c.clip(),c.drawImage(n,(o.orgPos.x-l)/i/s/a,(o.orgPos.y-l)/i/s/a,(o.width+2*l)/i/s/a,(o.height+2*l)/i/s/a,o.curPos.x/e.canvas.width-l,o.curPos.y/e.canvas.height-l-o.height,o.width+2*l,o.height+2*l),c.restore();const h=!e.puzzle.done&&(o.active||o.alsoActive);c.shadowColor=h?"rgba(100, 100, 100, 1)":"rgba(50, 50, 50, 1)",c.strokeStyle=h?"rgba(225, 225, 225, 1)":"rgba(220, 220, 220, 1)",c.shadowBlur=h?2:1,c.lineWidth=h?2:1,c.shadowOffsetX=c.shadowOffsetY=-1,c.lineCap="round",c.lineJoin="round",c.stroke()};const w=o((e=>{var t;e.pieces=(t=o(v(e)),e=>e.map(t))(e.pieces)})),P=e=>t=>o=>("function"==typeof t?t(o):t)?e(o):o;let z=1;const b={x:0,y:0},I=({x:e,y:t,bounding:o={x:1/0,y:1/0}})=>(b.x=b.x+e,b.y=b.y+t,{position:b,scale:z}),M=({focal:e,zoom:t,max:o=1e4,min:n=.05})=>{const c=z===o||z===n;z=((e,t,o)=>Math.max(t,Math.min(o,e)))(z*t,n,o);const s=c?b.x:e.x,i=c?b.y:e.y;return b.x=s-(s-b.x)*t,b.y=i-(i-b.y)*t,{position:b,scale:z}};var E=(e,{dpi:t=window.devicePixelRatio,bounding:o=null}={})=>{e.style.touchAction="none",e.style.userSelect="none",e.style.webkitUserSelect="none",e.style.overscrollBehaviour="contain";let n={},c=null;const s=t=>{e.dispatchEvent(new CustomEvent("pan",{detail:t,bubbles:!0,cancelable:!0,composed:!1}))},i=t=>{t.preventDefault(),n[t.pointerId]={x:t.offsetX,y:t.offsetY,deltaX:0,deltaY:0},e.addEventListener("pointerleave",r,{once:!0})},a=e=>{if(e.preventDefault(),!n[e.pointerId])return;if(2!==Object.keys(n).length)return;n[e.pointerId]={x:e.offsetX,y:e.offsetY,deltaX:e.offsetX-n[e.pointerId].x,deltaY:e.offsetY-n[e.pointerId].y};const o=Object.values(n),i=Math.sqrt(Math.pow(o[1].x-o[0].x,2)+Math.pow(o[1].y-o[0].y,2)),{position:a}=I({x:n[e.pointerId].deltaX*t*.7,y:n[e.pointerId].deltaY*t*.7}),{scale:r}=M({focal:{x:e.offsetX*t,y:e.offsetY*t},zoom:c?1+(i-c)/200:1});c=i,s({scale:r,position:a})},r=e=>{e.preventDefault(),delete n[e.pointerId],c=null};"ontouchstart"in window||navigator.maxTouchPoints>0||navigator.msMaxTouchPoints>0?(e.addEventListener("pointerdown",i),e.addEventListener("pointermove",a),e.addEventListener("pointerup",r),e.addEventListener("pointercancel",r)):e.addEventListener("wheel",(e=>{e.preventDefault(),e.ctrlKey?s(M({focal:{x:e.offsetX*t,y:e.offsetY*t},zoom:1-e.deltaY/100})):s(I({x:-e.deltaX,y:-e.deltaY}))}))};const C=({x:e,y:t},o=window.devicePixelRatio)=>[(e*o-b.x)/z,(t*o-b.y)/z],S=(e,t,o)=>{const[n,c]=C({x:o.offsetX,y:o.offsetY},e.canvas.DPI);return n>=t.curPos.x&&n<=t.curPos.x+t.width&&c>=t.curPos.y&&c<=t.curPos.y+t.height},D=(e,t,o)=>{const[n,c]=C({x:o.offsetX,y:o.offsetY},e.canvas.DPI);return{x:n-t.curPos.x,y:c-t.curPos.y}},Y=e=>({...e,pieces:e.pieces.map((e=>({...e,active:!1})))}),O=e=>{const t=e.pieces.filter((e=>e.active));return t.length&&t.length!==e.pieces.length?(t.forEach((t=>{Object.entries(t.neighbors).forEach((([o,n])=>{const c=e.pieces.find(i("id",n));if(((e,t,o,n)=>{const{attraction:c}=o.puzzle,s=l(n)?"y":"x",i="x"===s?"y":"x",a=!(e=>"top"===e||"left"===e)(n),r=e["y"===s?"height":"width"],h=a?t.curPos[s]+r:t.curPos[s]-r;return e.curPos[s]<=h+c&&e.curPos[s]>=h-c&&e.curPos[i]<=t.curPos[i]+c&&e.curPos[i]>=t.curPos[i]-c})(c,t,e,o)){const n={x:c.curPos.x+("right"===o?-c.width:"left"===o?+c.width:0),y:c.curPos.y+("top"===o?c.height:"bottom"===o?-c.height:0)};((e,[...t],o)=>{t.forEach((t=>{const n=e.pieces.find(i("id",t));n.curPos={x:n.curPos.x+o.x,y:n.curPos.y+o.y}}))})(e,t.connections,{x:n.x-t.curPos.x,y:n.y-t.curPos.y}),t.curPos=n,((e,t,o)=>{t.connections=m([t.id,o.id,...t.connections,...o.connections]),t.connections.forEach((o=>{const n=e.pieces.find((e=>e.id===o));n.connections=m(t.connections)})),o.connections.forEach((o=>{const n=e.pieces.find((e=>e.id===o));n.connections=m(t.connections)}))})(e,t,c)}}))})),e):e},X=e=>(e.pieces[0].connections.length!==e.puzzle.rows*e.puzzle.cols||e.puzzle.done||(e.puzzle.done=!0,e.puzzle.onComplete(e)),e),L=e=>(e.pieces=e.pieces.map((t=>({...t,curPos:{x:t.curPos.x-t.width>e.canvas.width*e.canvas.DPI?e.canvas.width-t.width:t.curPos.x,y:t.curPos.y-t.height>e.canvas.height*e.canvas.DPI?e.canvas.height-t.height:t.curPos.y}}))),e),T=e=>({image:e.image,canvas:e.canvas,pieces:JSON.parse(JSON.stringify(e.pieces)),puzzle:JSON.parse(JSON.stringify(e.puzzle))}),A=e=>o((t=>{const o=t.pieces.find((o=>S(t,o,e))),n=t.pieces.find((e=>e.active)),c=t.pieces.every((e=>e.active));!n||c?!o||n?t.puzzle.draggable&&(t.canvas.cursor="move"):t.canvas.cursor="grab":t.canvas.cursor="grabbing"})),N=o((e=>{e.canvas.element.style.cursor=e.canvas.cursor}));(()=>{if(!function(){const e=document.createElement("canvas").getContext("2d");e.fillRect(0,0,40,40),e.drawImage(e.canvas,-40,-40,80,80,50,50,20,20);const t=e.getImageData(50,50,30,30),o=new Uint32Array(t.data.buffer),n=(e,n)=>o[n*t.width+e];return[[9,9],[20,9],[9,20],[20,20]].some((([e,t])=>0!==n(e,t)))||[[10,10],[19,10],[10,19],[19,19]].some((([e,t])=>0===n(e,t)))}())return;const e=CanvasRenderingContext2D.prototype,t=e.drawImage;function o(e,t,o,n,c,s,i,a,r){const{width:l,height:h}=function(e){const t=t=>{const o=globalThis[t];return o&&e instanceof o};if(t("HTMLImageElement"))return{width:e.naturalWidth,height:e.naturalHeight};if(t("HTMLVideoElement"))return{width:e.videoWidth,height:e.videoHeight};if(t("SVGImageElement"))throw new TypeError("SVGImageElement isn't yet supported as source image.","UnsupportedError");if(t("HTMLCanvasElement")||t("ImageBitmap"))return e}(e);n<0&&(t+=n,n=Math.abs(n)),c<0&&(o+=c,c=Math.abs(c)),a<0&&(s+=a,a=Math.abs(a)),r<0&&(i+=r,r=Math.abs(r));const d=Math.max(t,0),u=Math.min(t+n,l),p=Math.max(o,0),g=Math.min(o+c,h),y=a/n,m=r/c;return[e,d,p,u-d,g-p,t<0?s-t*y:s,o<0?i-o*m:i,(u-d)*y,(g-p)*m]}function n(e){return[3,4,7,8].some((t=>!e[t]))}t?e.drawImage=function(e,c,s){const i=9===arguments.length;if(!i)return t.apply(this,[...arguments]);const a=o(...arguments);return n(a)?void 0:t.apply(this,a)}:console.error("This script requires a basic implementation of drawImage")})();const k=o((e=>{e.canvas.ctx.save(),e.canvas.ctx.setTransform(1,0,0,1,0,0),e.canvas.ctx.clearRect(0,0,e.canvas.width,e.canvas.height),e.canvas.ctx.restore()}));return e.puzzle=async({element:e,restore:n={},image:i="",pieces:r={x:6,y:4},attraction:l=20,size:h=.8,draggable:d=!1,aligned:u=!1,onComplete:g=(()=>{}),onChange:m=(()=>{})})=>{const v="string"==typeof e?document.querySelector(e):e;if(!v)return void console.warn(`Couldn't find element: ${e}`);const z=(e=>{const t=window.devicePixelRatio,o="CANVAS"===e.tagName?e:document.createElement("canvas"),n=o.getContext("2d"),{height:c,width:s}=getComputedStyle(e);return o.width=parseInt(s,0)*t,o.height=parseInt(c,0)*t,o.style.width=parseInt(s,0)+"px",o.style.height=parseInt(c,0)+"px","CANVAS"!==e.tagName&&e.appendChild(o),{element:o,ctx:n,width:o.width,height:o.height,DPI:t}})(v),b=n.image||await(I=i,new Promise((e=>{var t=new Image;t.onload=()=>e({image:t,width:t.width,height:t.height}),t.src=I})));var I;const M=()=>n.puzzle||((e,t,o,n,c,s,i,a)=>{const{width:r,height:l}=getComputedStyle(n),h=t.width<t.height,d=Math.min(2,window.devicePixelRatio),u=parseInt([h?l:r],0)/t[h?"height":"width"];return{timeStamp:Date.now(),done:!1,cols:e.x,rows:e.y,width:t.width*u*d,height:t.height*u*d,attraction:o,scale:u,occupy:c,draggable:s,aligned:i,onComplete:a}})(r,b,l,v,h,d,u,g),j=n.pieces||(e=>{const t=[...Array(e.rows*e.cols)],o=e.width/e.cols*e.occupy,n=e.height/e.rows*e.occupy;return t.map(((t,c)=>({id:c,orgPos:{x:c%e.cols*o,y:Math.floor(c/e.cols)*n},curPos:{x:0,y:0},width:o,height:n,neighbors:a(c,e.rows,e.cols),active:!1,connections:[]}))).reduce(p,[])})(M()),R="function"==typeof m&&o(t(T,m)),V=()=>({scale:1,position:{x:0,y:0},image:b,canvas:z,pieces:j,puzzle:M()});let H=V();E(z.element),z.element.addEventListener("pan",(e=>{e.preventDefault();const{detail:{scale:t,position:o}}=e;H.scale=t,H.position=o,k(H),z.ctx.setTransform(t,0,0,t,o.x,o.y),w(H)})),H=n.puzzle?t(w)(H):t(y,w)(H);const J=[c(window).resize((e=>H=t(L,w)(H))),c(H.canvas).mousedown((e=>H=t((e=>o=>{return{...o,pieces:t(x(((t,n,c,i)=>({...t,active:!(i.find(s("active"))||!S(o,t,e))&&D(o,t,e)}))),x(((t,n,c)=>({...t,active:c.find((e=>e.active&&e.connections.includes(t.id)))||!c.find(s("active"))&&o.puzzle.draggable?D(o,t,e):t.active}))),P((n=f,e=>e.sort(n)))((e=>!o.puzzle.done&&e.filter((e=>e.active)).length!==o.pieces.length)))(o.pieces)};var n})(e),A(e),N,k,w)(H))),c(H.canvas).mousemove((e=>{H=t(A(e),(({offsetX:e,offsetY:t})=>o=>{const[n,c]=C({x:e,y:t},o.canvas.DPI);return{...o,pieces:o.pieces.map((e=>({...e,curPos:e.active?{x:n-e.active.x,y:c-e.active.y}:e.curPos})))}})(e),k,w,N)(H)})),c(document.body).mouseup((e=>H=t(O,Y,A(e),k,w,N,R,X)(H)))];return{newGame:()=>H=t(y,w)(V()),getState:()=>T(H),setState:e=>H=t(T,w)(e),update:()=>H=t(w)(H),destroy:()=>{"CANVAS"!==e.tagName&&H.canvas.element.remove(),H=null,J.map((e=>e.remove()))}}},Object.defineProperty(e,"__esModule",{value:!0}),e}({});

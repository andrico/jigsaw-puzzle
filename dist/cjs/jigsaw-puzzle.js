"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const e=e=>t=>(e(t),t),t=(e=Math.random())=>.5*(Math.cos(6669.1337*Math.sin(1337.1337*(e+69)))+1),i=e=>t=>i=>("function"==typeof t?t(i):t)?e(i):i,o=(...e)=>t=>[...e].reduce(((e,t)=>t(e)),t),n=e=>JSON.parse(JSON.stringify(e)),s=(e,t,i)=>{const o=e+1,n={top:o>i?e-i:void 0,right:o%i!=0?e+1:void 0,bottom:o<=(t-1)*i?e+i:void 0,left:o%i!=(i>1?1:0)?e-1:void 0};return JSON.parse(JSON.stringify(n))},a=["top","right","bottom","left"],c=({shape:e,size:t})=>({shape:"out"===e?"in":"out",size:t}),r=["top","right","bottom","left"],p=(e,t)=>r.indexOf(e[0])>r.indexOf(t[0])?1:-1,d=(e,i)=>[...Array(e.y*e.x)].map(((t,i)=>({id:i,origin:{x:i%e.x,y:Math.floor(i/e.x)},pos:{x:0,y:0},neighbors:s(i,e.y,e.x),active:!1,connections:[]}))).reduce((e=>(i,o)=>{const n=(e,t)=>i.find((t=>t.id===e))?.sides[{top:"bottom",right:"left",bottom:"top",left:"right"}[t]],s=[...Object.entries({...(({neighbors:i})=>Object.keys(i).reduce(((o,s)=>{const a=n(i[s],s);return{[s]:a?c(a):t()>=.5?{shape:"out",size:e?Math.random():1}:{shape:"in",size:e?Math.random():1},...o}}),{}))(o),...(({neighbors:e})=>a.filter((t=>!Object.keys(e).includes(t))).reduce(((e,t)=>({[t]:{shape:"flat",size:1},...e})),{}))(o)})].sort(p).reduce(((e,[t,i])=>({...e,[t]:i})),{});return[{...o,sides:s},...i]})(i),[]),l=e=>[...new Set(e)],h=(e,t)=>t.active?-1:1,u=e=>t=>t.reduceRight(((t,i,o,n)=>[...t,e(i,o,n,t)]),[]);function x(e){const t=[...e];let i=t.length;for(;i>0;){let e=Math.floor(Math.random()*i);i--;let o=t[i];t[i]=t[e],t[e]=o}return t}const y=e=>Math.random()*(e- -1*e)+-1*e,m=(e=!1)=>i=>({...i,pieces:e?x(i.pieces).map(((e,t)=>({...e,connections:[],pos:{x:t%i.size.x/i.size.x*2-.4+y(.03),y:Math.floor(t/i.size.x)/i.size.y*2-.4+y(.03)}}))):i.pieces.map((e=>({...e,connections:[],pos:{x:2*t()-.5,y:2*t()-.5}})))}),f=(e,{x:t,y:i,width:o,height:n})=>t>=e.pos.x&&t<=e.pos.x+o&&i>=e.pos.y&&i<=e.pos.y+n,v=(e,{x:t,y:i})=>({x:t-e.pos.x,y:i-e.pos.y}),g=e((e=>{e.pieces=e.pieces.map((e=>({...e,active:!1})))})),z=(e,t)=>i=>i[e]===t,w=e((e=>{const t=e.pieces.filter((e=>e.active)),{size:i}=e;t.length&&t.length!==e.pieces.length&&t.forEach((t=>{Object.entries(t.neighbors).forEach((([o,n])=>{const s=e.pieces.find(z("id",n));if(((e,t,i,o)=>{const{attraction:n,size:s}=i,a=n/100,c=(e=>"top"===e||"bottom"===e)(o)?"y":"x",r="x"===c?"y":"x",p=!(e=>"top"===e||"left"===e)(o),d="y"===c?1/s.y:1/s.x,l=p?t.pos[c]+d:t.pos[c]-d;return e.pos[c]<=l+a&&e.pos[c]>=l-a&&e.pos[r]<=t.pos[r]+a&&e.pos[r]>=t.pos[r]-a})(s,t,e,o)){const n={x:s.pos.x+("right"===o?-1/i.x:"left"===o?1/i.x:0),y:s.pos.y+("top"===o?1/i.y:"bottom"===o?-1/i.y:0)};((e,[...t],i)=>{t.forEach((t=>{const o=e.pieces.find(z("id",t));o.pos={x:o.pos.x+i.x,y:o.pos.y+i.y}}))})(e,t.connections,{x:n.x-t.pos.x,y:n.y-t.pos.y}),t.pos=n,((e,t,i)=>{t.connections=l([t.id,i.id,...t.connections,...i.connections]),t.connections.forEach((i=>{const o=e.pieces.find((e=>e.id===i));o.connections=l(t.connections)})),i.connections.forEach((i=>{const o=e.pieces.find((e=>e.id===i));o.connections=l(t.connections)}))})(e,t,s)}}))}))})),b=e((e=>{"active"===e.status&&(e.moves=e.moves+1),e.pieces[0].connections.length!==e.size.y*e.size.x||e.done||(e.done=!0)})),M=({x:t,y:i})=>e((e=>{const o=e.pieces.find((e=>e.active));if(o)return void(e.status="active");!e.pieces.find((o=>f(o,{x:t,y:i,width:1/e.size.x,height:1/e.size.y})))||o?e.status="idle":e.status="ready"}));(()=>{if(!function(){const e=document.createElement("canvas").getContext("2d");e.fillRect(0,0,40,40),e.drawImage(e.canvas,-40,-40,80,80,50,50,20,20);const t=e.getImageData(50,50,30,30),i=new Uint32Array(t.data.buffer),o=(e,o)=>i[o*t.width+e];return[[9,9],[20,9],[9,20],[20,20]].some((([e,t])=>0!==o(e,t)))||[[10,10],[19,10],[10,19],[19,19]].some((([e,t])=>0===o(e,t)))}())return;const e=CanvasRenderingContext2D.prototype,t=e.drawImage;function i(e,t,i,o,n,s,a,c,r){const{width:p,height:d}=function(e){const t=t=>{const i=globalThis[t];return i&&e instanceof i};if(t("HTMLImageElement"))return{width:e.naturalWidth,height:e.naturalHeight};if(t("HTMLVideoElement"))return{width:e.videoWidth,height:e.videoHeight};if(t("SVGImageElement"))throw new TypeError("SVGImageElement isn't yet supported as source image.","UnsupportedError");if(t("HTMLCanvasElement")||t("ImageBitmap"))return e}(e);o<0&&(t+=o,o=Math.abs(o)),n<0&&(i+=n,n=Math.abs(n)),c<0&&(s+=c,c=Math.abs(c)),r<0&&(a+=r,r=Math.abs(r));const l=Math.max(t,0),h=Math.min(t+o,p),u=Math.max(i,0),x=Math.min(i+n,d),y=c/o,m=r/n;return[e,l,u,h-l,x-u,t<0?s-t*y:s,i<0?a-i*m:a,(h-l)*y,(x-u)*m]}function o(e){return[3,4,7,8].some((t=>!e[t]))}t&&(e.drawImage=function(e,n,s){const a=9===arguments.length;if(!a)return t.apply(this,[...arguments]);const c=i(...arguments);return o(c)?void 0:t.apply(this,c)})})();let E=1;const I={x:canvas.width/2,y:canvas.height/2},S=({x:e,y:t,bounding:i={x:1/0,y:1/0}})=>(I.x=I.x+e,I.y=I.y+t,{position:I,scale:E}),O=({focal:e,zoom:t,max:i=1e4,min:o=.05})=>{const n=E===i||E===o;E=((e,t,i)=>Math.max(t,Math.min(i,e)))(E*t,o,i);const s=n?I.x:e.x,a=n?I.y:e.y;return I.x=s-(s-I.x)*t,I.y=a-(a-I.y)*t,{position:I,scale:E}},C=()=>{I.x=canvas.width/2*Math.min(2,canvas.devicePixelRatio),I.y=canvas.height/2*Math.min(2,canvas.devicePixelRatio)};var T=(e,{dpi:t=Math.min(2,window.devicePixelRatio),bounding:i=null,initScale:o=1,zoomable:n=!0}={})=>{e.style.touchAction="none",e.style.userSelect="none",e.style.webkitUserSelect="none",e.style.overscrollBehavior="contain";let s={},a=null;E=o;const c=t=>{e.dispatchEvent(new CustomEvent("pan",{detail:t,bubbles:!0,cancelable:!0,composed:!1}))};setTimeout((()=>c({scale:E,position:I})));const r=t=>{t.preventDefault(),s[t.pointerId]={x:t.offsetX,y:t.offsetY,deltaX:0,deltaY:0},e.addEventListener("pointerleave",d,{once:!0})},p=e=>{if(e.preventDefault(),!s[e.pointerId])return;s[e.pointerId]={x:e.offsetX,y:e.offsetY,deltaX:e.offsetX-s[e.pointerId].x,deltaY:e.offsetY-s[e.pointerId].y};const i=Object.values(s),{position:o}=S({x:s[e.pointerId].deltaX*t*.7,y:s[e.pointerId].deltaY*t*.7}),n=2!==Object.keys(s).length?1:Math.sqrt(Math.pow(i[1].x-i[0].x,2)+Math.pow(i[1].y-i[0].y,2)),{scale:r}=O({focal:{x:e.offsetX*t,y:e.offsetY*t},zoom:2===Object.keys(s).length&&a?1+(n-a)/200:1});a=n,c({scale:r,position:o})},d=e=>{e.preventDefault(),delete s[e.pointerId],a=null};return"ontouchstart"in window||navigator.maxTouchPoints>0||navigator.msMaxTouchPoints>0?(e.addEventListener("pointerdown",r),e.addEventListener("pointermove",p),e.addEventListener("pointerup",d),e.addEventListener("pointercancel",d)):e.addEventListener("wheel",(e=>{e.preventDefault(),n&&(e.ctrlKey?c(O({focal:{x:e.offsetX*t,y:e.offsetY*t},zoom:1-e.deltaY/100})):c(S({x:-e.deltaX,y:-e.deltaY})))})),{zoom:i=>{O({focal:{x:e.width/2*t,y:e.height/2*t},zoom:i}),c({scale:E,position:I})},restore:()=>{C(),c({scale:E,position:I})}}};[...Array(20)].map(((e,t)=>Math.floor(20*(1-t/20))/20));const L=e=>{const{height:t,width:i}=getComputedStyle(e.parentElement),o=Math.min(2,window.devicePixelRatio);e.width=parseInt(i,0)*o,e.height=parseInt(t,0)*o},P=e((e=>{const{canvas:t,ctx:i}=e;i.save(),i.setTransform(1,0,0,1,0,0),i.clearRect(0,0,t.width,t.height),i.restore()})),Y=t=>e((e=>{P(e),t.pieces.map(X(t,e))})),X=(e,t)=>i=>{const o={x:t.size.x/e.size.x,y:t.size.y/e.size.y},{ctx:n,image:s}=t,a=t.shapes[i.id],c=Math.max(o.x,o.y);n.save(),n.translate(i.pos.x*t.size.x,i.pos.y*t.size.y);const r=!e.done&&(i.active||i.alsoActive),p=8/Math.max(t.zoom,4);n.lineWidth=r?2*p:p,n.shadowOffsetX=n.shadowOffsetY=-p/2,n.shadowBlur=p,n.shadowColor=r?"rgba(100, 100, 100, 1)":"rgba(50, 50, 50, 1)",n.stroke(a),n.clip(a),n.drawImage(s,i.origin.x*o.x-c,i.origin.y*o.y-c,o.x+c*t.dpi,o.y+c*t.dpi,i.pos.x/t.size.x-c,i.pos.y/t.size.y-c,o.x+c*t.dpi,o.y+c*t.dpi),n.restore()},k=(e,t,...i)=>{const o=t*Math.PI/180,{sin:n,cos:s}=Math;return i.map((([t,i])=>[(t-e.x)*s(o)-(i-e.y)*n(o)+e.x,(t-e.x)*n(o)+(i-e.y)*s(o)+e.y])).flat()},A=(e,t)=>{const[i]=e[0];return e.map((e=>k({x:i[0],y:i[1]},t,...e)))},R=(e,t)=>e.map((e=>e.map((e=>[e[0]+t.x,e[1]+t.y])))),N=({size:e,shapes:t,knobsize:i})=>{const o=new Path2D;if(4===!t.length)return;return[{x:0,y:0,angle:0},{x:e.x,y:0,angle:90},{x:e.x,y:e.y,angle:180},{x:0,y:e.y,angle:270}].forEach(((n,s)=>{const a=s%2==1?e.y:e.x,c=t[s];if("flat"===c){const e=k(n,n.angle,[n.x+a,n.y]);o.lineTo(...e)}else{const e=(({knobsize:e=1,length:t=100})=>{const i=t/2;return[[[0,0],[i-20*e,4*e],[i-13*e,0]],[[i-13*e,0],[i-10*e,-2*e],[i-12*e,-5*e]],[[i-12*e,-5*e],[i-30*e,-30*e],[i,-30*e]],[[i,-30*e],[i- -30*e,-30*e],[i- -12*e,-5*e]],[[i- -12*e,-5*e],[i- -10*e,-2*e],[i- -13*e,0]],[[i- -13*e,0],[i- -20*e,4*e],[t,0]]]})({length:a,knobsize:i[s]});A(R("in"===c?(e=>e.map((e=>e.map((e=>[e[0],-1*e[1]])))))(e):e,n),n.angle).forEach((e=>o.bezierCurveTo(...e.flat())))}})),o.closePath(),o},j=(e,t,i)=>i.reduce(((i,o)=>{const n=Object.values(o.sides),s=n.map((({shape:e})=>e)),a=n.map((({size:i})=>(.6+.4*i)*Math.min(e,t)/110));return{...i,[o.id]:N({size:{x:e,y:t},shapes:s,knobsize:a})}}),{});exports.puzzle=async({element:t,image:s="",pieces:a={x:6,y:4},attraction:c=5,aligned:r=!0,individualize:p=!1,zoom:l,zoomable:x=!0,beforeInit:y=(()=>{}),onInit:z=(()=>{}),onComplete:S=(()=>{}),onChange:O=(()=>{})})=>{const C="string"==typeof t?document.querySelector(t):t;if(!C)return;const{canvas:P,ctx:X}=(e=>{const t=e&&"CANVAS"===e.tagName?e:document.createElement("canvas"),i=t.getContext("2d");return e&&"CANVAS"!==e.tagName&&(e.appendChild(t),t.style.width="100%",t.style.height="100%",L(t)),i.strokeStyle="rgba(220, 220, 220, 1)",i.lineCap="round",i.lineJoin="round",{canvas:t,ctx:i}})(C);y(P);const{image:k,width:A,height:R}=await(N=s,new Promise((e=>{const t=new Image;t.onload=()=>{e({image:t,width:t.width,height:t.height})},t.src=N})));var N;const D={moves:0,status:"idle",done:!1,startTime:Date.now(),attraction:c,size:a,pieces:d(a,p)},V={url:s,zoom:1,position:{x:0,y:0},size:{x:A,y:R},canvas:P,ctx:X,image:k,dpi:Math.min(2,window.devicePixelRatio),shapes:j(A/a.x,R/a.y,D.pieces)};let H={};H.puzzle=o(m(r))(D),H.ui=Y(H.puzzle)(V);const{zoom:J,restore:B}=T(P,{dpi:Math.min(2,window.devicePixelRatio),zoomable:x,initScale:l||Math.min(P.width/H.ui.size.x*.9,P.height/H.ui.size.y*.9)}),G=()=>{H.ui=o(Y(H.puzzle),(t=>e((e=>{e.canvas.style.cursor="active"===t.status?"grabbing":"ready"===t.status?"grab":"default"})))(H.puzzle))(H.ui)};P.addEventListener("pan",(e=>{e.preventDefault();const{detail:{scale:t,position:i}}=e;H.ui.zoom=t,H.ui.position=i,H.ui.ctx.setTransform(t,0,0,t,i.x,i.y),G()})),setTimeout((()=>z(H)));const U=({x:e,y:t})=>{const[i,o]=(({x:e,y:t},i=Math.min(2,window.devicePixelRatio))=>[(e*i-I.x)/E,(t*i-I.y)/E])({x:e,y:t},H.ui.dpi);return{x:i/H.ui.size.x,y:o/H.ui.size.y}};return H.ui.canvas.addEventListener("pointerdown",(({offsetX:e,offsetY:t})=>{const n=U({x:e,y:t});H.puzzle=o((({x:e,y:t})=>n=>{return{...n,pieces:o(u(((i,o,s,a)=>{return{...i,active:!(a.find((c="active",e=>e[c]))||!f(i,{x:e,y:t,width:1/n.size.x,height:1/n.size.y}))&&v(i,{x:e,y:t})};var c})),u(((i,o,n)=>({...i,active:n.find((e=>e.active&&e.connections.includes(i.id)))?v(i,{x:e,y:t}):i.active}))),i((s=h,e=>e.sort(s)))((e=>!n.done&&e.filter((e=>e.active)).length!==n.pieces.length)))(n.pieces)};var s})(n),M(n))(H.puzzle),G()})),H.ui.canvas.addEventListener("pointermove",(({offsetX:e,offsetY:t})=>{const i=U({x:e,y:t});H.puzzle=o((({x:e,y:t})=>i=>({...i,pieces:"idle"===i.status?i.pieces:i.pieces.map((i=>({...i,pos:i.active?{x:e-i.active.x,y:t-i.active.y}:i.pos})))}))(i),M(i))(H.puzzle),G()})),H.ui.canvas.addEventListener("pointerup",(({offsetX:e,offsetY:t})=>{const i=U({x:e,y:t});H.puzzle=o(w,g,b,M(i))(H.puzzle),G(),O({ui:H.ui,puzzle:n(H.puzzle)}),H.puzzle.done&&S(H)})),window.addEventListener("resize",(()=>{const{zoom:e,position:t}=H.ui;L(H.ui.canvas),X.setTransform(e,0,0,e,t.x,t.y),G()})),{newGame:()=>{H.puzzle=o(m(r))(D),G()},getState:()=>n(H.puzzle),setState:e=>{H.puzzle=e,G()},destroy:()=>{"CANVAS"!==t.tagName&&H.ui.canvas.remove(),H=null},setZoom:x?J:()=>{},getZoom:()=>H.ui.zoom,centralize:B}};

"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const e=e=>t=>(e(t),t),t=(e=Math.random())=>.5*(Math.cos(6669.1337*Math.sin(1337.1337*(e+69)))+1),n=e=>t=>n=>("function"==typeof t?t(n):t)?e(n):n,o=(...e)=>t=>[...e].reduce(((e,t)=>t(e)),t),i=e=>JSON.parse(JSON.stringify(e)),s=(e,t,n)=>{const o=e+1,i={top:o>n?e-n:void 0,right:o%n!=0?e+1:void 0,bottom:o<=(t-1)*n?e+n:void 0,left:o%n!=(n>1?1:0)?e-1:void 0};return JSON.parse(JSON.stringify(i))},a=["top","right","bottom","left"],c=e=>"top"===e||"bottom"===e,r=(e,n)=>{const o=(t,n)=>e.find((e=>e.id===t))?.sides[{top:"bottom",right:"left",bottom:"top",left:"right"}[n]],i={...(({neighbors:e})=>Object.keys(e).reduce(((n,i)=>{const s=o(e[i],i);return{[i]:s?(a=s,"out"===a?"in":"out"):t()>=.5?"out":"in",...n};var a}),{}))(n),...(({neighbors:e})=>a.filter((t=>!Object.keys(e).includes(t))).reduce(((e,t)=>({[t]:"flat",...e})),{}))(n)};return[{...n,sides:i},...e]},d=e=>[...new Set(e)],l=(e,t)=>t.active?-1:1,p=e=>t=>t.reduceRight(((t,n,o,i)=>[...t,e(n,o,i,t)]),[]);function h(e){const t=[...e];let n=t.length;for(;n>0;){let e=Math.floor(Math.random()*n);n--;let o=t[n];t[n]=t[e],t[e]=o}return t}const y=e=>Math.random()*(e- -1*e)+-1*e,x=(e=!1)=>n=>({...n,pieces:e?h(n.pieces).map(((e,t)=>({...e,connections:[],pos:{x:2*(t%n.size.x/n.size.x+y(.015))-.42,y:2*(Math.floor(t/n.size.x)/n.size.y+y(.015))-.42}}))):n.pieces.map((e=>({...e,connections:[],pos:{x:2*t()-.5,y:2*t()-.5}})))}),u=(e,{x:t,y:n,width:o,height:i})=>t>=e.pos.x&&t<=e.pos.x+o&&n>=e.pos.y&&n<=e.pos.y+i,f=(e,{x:t,y:n})=>({x:t-e.pos.x,y:n-e.pos.y}),m=e((e=>{e.pieces=e.pieces.map((e=>({...e,active:!1})))})),g=(e,t)=>n=>n[e]===t,v=e((e=>{const t=e.pieces.filter((e=>e.active)),{size:n}=e;t.length&&t.length!==e.pieces.length&&t.forEach((t=>{Object.entries(t.neighbors).forEach((([o,i])=>{const s=e.pieces.find(g("id",i));if(((e,t,n,o)=>{const{attraction:i,size:s}=n,a=i/100,r=c(o)?"y":"x",d="x"===r?"y":"x",l=!(e=>"top"===e||"left"===e)(o),p="y"===r?1/s.y:1/s.x,h=l?t.pos[r]+p:t.pos[r]-p;return e.pos[r]<=h+a&&e.pos[r]>=h-a&&e.pos[d]<=t.pos[d]+a&&e.pos[d]>=t.pos[d]-a})(s,t,e,o)){const i={x:s.pos.x+("right"===o?-1/n.x:"left"===o?1/n.x:0),y:s.pos.y+("top"===o?1/n.y:"bottom"===o?-1/n.y:0)};((e,[...t],n)=>{t.forEach((t=>{const o=e.pieces.find(g("id",t));o.pos={x:o.pos.x+n.x,y:o.pos.y+n.y}}))})(e,t.connections,{x:i.x-t.pos.x,y:i.y-t.pos.y}),t.pos=i,((e,t,n)=>{t.connections=d([t.id,n.id,...t.connections,...n.connections]),t.connections.forEach((n=>{const o=e.pieces.find((e=>e.id===n));o.connections=d(t.connections)})),n.connections.forEach((n=>{const o=e.pieces.find((e=>e.id===n));o.connections=d(t.connections)}))})(e,t,s)}}))}))})),w=e((e=>{"active"===e.status&&(e.moves=e.moves+1),e.pieces[0].connections.length!==e.size.y*e.size.x||e.done||(e.done=!0)})),z=({x:t,y:n})=>e((e=>{const o=e.pieces.find((e=>e.active));if(o)return void(e.status="active");!e.pieces.find((o=>u(o,{x:t,y:n,width:1/e.size.x,height:1/e.size.y})))||o?e.status="idle":e.status="ready"}));(()=>{if(!function(){const e=document.createElement("canvas").getContext("2d");e.fillRect(0,0,40,40),e.drawImage(e.canvas,-40,-40,80,80,50,50,20,20);const t=e.getImageData(50,50,30,30),n=new Uint32Array(t.data.buffer),o=(e,o)=>n[o*t.width+e];return[[9,9],[20,9],[9,20],[20,20]].some((([e,t])=>0!==o(e,t)))||[[10,10],[19,10],[10,19],[19,19]].some((([e,t])=>0===o(e,t)))}())return;const e=CanvasRenderingContext2D.prototype,t=e.drawImage;function n(e,t,n,o,i,s,a,c,r){const{width:d,height:l}=function(e){const t=t=>{const n=globalThis[t];return n&&e instanceof n};if(t("HTMLImageElement"))return{width:e.naturalWidth,height:e.naturalHeight};if(t("HTMLVideoElement"))return{width:e.videoWidth,height:e.videoHeight};if(t("SVGImageElement"))throw new TypeError("SVGImageElement isn't yet supported as source image.","UnsupportedError");if(t("HTMLCanvasElement")||t("ImageBitmap"))return e}(e);o<0&&(t+=o,o=Math.abs(o)),i<0&&(n+=i,i=Math.abs(i)),c<0&&(s+=c,c=Math.abs(c)),r<0&&(a+=r,r=Math.abs(r));const p=Math.max(t,0),h=Math.min(t+o,d),y=Math.max(n,0),x=Math.min(n+i,l),u=c/o,f=r/i;return[e,p,y,h-p,x-y,t<0?s-t*u:s,n<0?a-n*f:a,(h-p)*u,(x-y)*f]}function o(e){return[3,4,7,8].some((t=>!e[t]))}t?e.drawImage=function(e,i,s){const a=9===arguments.length;if(!a)return t.apply(this,[...arguments]);const c=n(...arguments);return o(c)?void 0:t.apply(this,c)}:console.error("This script requires a basic implementation of drawImage")})();let b=1;const M={x:window.innerWidth/2,y:window.innerHeight/2},E=({x:e,y:t,bounding:n={x:1/0,y:1/0}})=>(M.x=M.x+e,M.y=M.y+t,{position:M,scale:b}),I=({focal:e,zoom:t,max:n=1e4,min:o=.05})=>{const i=b===n||b===o;b=((e,t,n)=>Math.max(t,Math.min(n,e)))(b*t,o,n);const s=i?M.x:e.x,a=i?M.y:e.y;return M.x=s-(s-M.x)*t,M.y=a-(a-M.y)*t,{position:M,scale:b}};var S=(e,{dpi:t=Math.min(2,window.devicePixelRatio),bounding:n=null,initScale:o=1}={})=>{e.style.touchAction="none",e.style.userSelect="none",e.style.webkitUserSelect="none",e.style.overscrollBehaviour="contain";let i={},s=null;b=o;const a=t=>{e.dispatchEvent(new CustomEvent("pan",{detail:t,bubbles:!0,cancelable:!0,composed:!1}))};setTimeout((()=>a({scale:b,position:M})));const c=t=>{t.preventDefault(),i[t.pointerId]={x:t.offsetX,y:t.offsetY,deltaX:0,deltaY:0},e.addEventListener("pointerleave",d,{once:!0})},r=e=>{if(e.preventDefault(),!i[e.pointerId])return;if(2!==Object.keys(i).length)return;i[e.pointerId]={x:e.offsetX,y:e.offsetY,deltaX:e.offsetX-i[e.pointerId].x,deltaY:e.offsetY-i[e.pointerId].y};const n=Object.values(i),o=Math.sqrt(Math.pow(n[1].x-n[0].x,2)+Math.pow(n[1].y-n[0].y,2)),{position:c}=E({x:i[e.pointerId].deltaX*t*.7,y:i[e.pointerId].deltaY*t*.7}),{scale:r}=I({focal:{x:e.offsetX*t,y:e.offsetY*t},zoom:s?1+(o-s)/200:1});s=o,a({scale:r,position:c})},d=e=>{e.preventDefault(),delete i[e.pointerId],s=null};return"ontouchstart"in window||navigator.maxTouchPoints>0||navigator.msMaxTouchPoints>0?(e.addEventListener("pointerdown",c),e.addEventListener("pointermove",r),e.addEventListener("pointerup",d),e.addEventListener("pointercancel",d)):e.addEventListener("wheel",(e=>{e.preventDefault(),e.ctrlKey?a(I({focal:{x:e.offsetX*t,y:e.offsetY*t},zoom:1-e.deltaY/100})):a(E({x:-e.deltaX,y:-e.deltaY}))})),{zoom:e=>{I({focal:{x:window.innerWidth/2*t,y:window.innerHeight/2*t},zoom:e}),a({scale:b,position:M})},restore:()=>{M.x=window.innerWidth/2*Math.min(2,window.devicePixelRatio),M.y=window.innerHeight/2*Math.min(2,window.devicePixelRatio),a({scale:b,position:M})}}};const C=(e=100,t=100)=>{const n=t/110,o=e/2;return[{cx1:0,cy1:0,cx2:o-20*n,cy2:4*n,ex:o-13*n,ey:0*n},{cx1:o-13*n,cy1:0*n,cx2:o-10*n,cy2:-2*n,ex:o-12*n,ey:-5*n},{cx1:o-12*n,cy1:-5*n,cx2:o-30*n,cy2:-30*n,ex:o,ey:-30*n},{cx1:o,cy1:-30*n,cx2:o- -30*n,cy2:-31*n,ex:o- -12*n,ey:-5*n},{cx1:o- -12*n,cy1:-5*n,cx2:o- -10*n,cy2:-2*n,ex:o- -13*n,ey:0*n},{cx1:o- -13*n,cy1:0*n,cx2:o- -20*n,cy2:4*n,ex:e,ey:0*n}]},T=e=>{const{height:t,width:n}=getComputedStyle(e.parentElement),o=Math.min(2,window.devicePixelRatio);e.width=parseInt(n,0)*o,e.height=parseInt(t,0)*o},O=e((e=>{const{canvas:t,ctx:n}=e;n.save(),n.setTransform(1,0,0,1,0,0),n.clearRect(0,0,t.width,t.height),n.restore()})),L=t=>e((e=>{O(e),t.pieces.map(X(t,e))})),Y=["top","right","bottom","left"],P=(e,t)=>Y.indexOf(e[0])>Y.indexOf(t[0])?1:-1,X=(e,t)=>n=>{const o={x:n.pos.x*t.width,y:n.pos.y*t.height},i={x:1/e.size.x*t.width,y:1/e.size.y*t.height},{ctx:s,image:a}=t,r=Math.max(i.x,i.y);s.save(),s.beginPath(),s.translate(o.x,o.y+i.y),[...Object.entries(n.sides)].sort(P).forEach(((e,t)=>{const n={x:c(e[0])?-i.y:-i.x,y:c(e[0])?i.x:i.y};!function(e,[t,n],o,i){e.translate(0,o.x);const s=c(t)?i.x:i.y;if("flat"===n)e.lineTo(o.y,0);else{("in"===n?((e,t=1)=>e.map(((e,n)=>({cx1:e.cx1*t,cy1:-1*e.cy1,cx2:e.cx2*t,cy2:-1*e.cy2,ex:e.ex*t,ey:-1*e.ey}))))(C(s,Math.min(i.x,i.y))):C(s,Math.min(i.x,i.y))).forEach((t=>{e.bezierCurveTo(t.cx1,t.cy1,t.cx2,t.cy2,t.ex,t.ey)}))}e.rotate(Math.PI/2)}(s,e,n,i)})),s.closePath(),s.clip(),s.drawImage(a,n.origin.x*i.x-r,n.origin.y*i.y-r,i.x+2*r,i.y+2*r,n.pos.x/t.width-r,n.pos.y/t.height-r-i.y,i.x+2*r,i.y+2*r),s.restore();const d=!e.done&&(n.active||n.alsoActive),l=1/Math.max(t.zoom,1);console.log(l),s.shadowColor=d?"rgba(100, 100, 100, 1)":"rgba(50, 50, 50, 1)",s.strokeStyle=d?"rgba(225, 225, 225, 1)":"rgba(220, 220, 220, 1)",s.shadowBlur=d?2*l:l,s.lineWidth=d?2*l:l,s.shadowOffsetX=s.shadowOffsetY=-1,s.lineCap="round",s.lineJoin="round",s.stroke()};exports.puzzle=async({element:t,image:a="",pieces:c={x:6,y:4},attraction:d=5,aligned:h=!1,zoom:y,beforeInit:g=(()=>{}),onInit:E=(()=>{}),onComplete:I=(()=>{}),onChange:C=(()=>{})})=>{const O="string"==typeof t?document.querySelector(t):t;if(!O)return void console.warn(`Couldn't find element: ${t}`);const{canvas:Y,ctx:P}=(e=>{const t=e&&"CANVAS"===e.tagName?e:document.createElement("canvas"),n=t.getContext("2d");return e&&"CANVAS"!==e.tagName&&(e.appendChild(t),t.style.width="100%",t.style.height="100%",T(t)),{canvas:t,ctx:n}})(O);g(Y);const{image:X,width:A,height:N}=await(H=a,new Promise((e=>{var t=new Image;t.onload=()=>e({image:t,width:t.width,height:t.height}),t.src=H})));var H;const R={moves:0,status:"idle",done:!1,startTime:Date.now(),attraction:d,size:{x:c.x,y:c.y},pieces:(D=c,[...Array(D.y*D.x)].map(((e,t)=>({id:t,origin:{x:t%D.x,y:Math.floor(t/D.x)},pos:{x:0,y:0},neighbors:s(t,D.y,D.x),active:!1,connections:[]}))).reduce(r,[]))};var D;const j={url:a,zoom:1,position:{x:0,y:0},canvas:Y,ctx:P,image:X,useCache:!1,height:N,width:A};let W={};W.puzzle=o(x(h))(R),W.ui=L(W.puzzle)(j);const{zoom:k,restore:V}=S(Y,{initScale:y||Math.min(window.innerWidth/W.ui.width*.9,window.innerHeight/W.ui.height*.9)}),J=()=>{W.ui=o(L(W.puzzle),(t=>e((e=>{e.canvas.style.cursor="active"===t.status?"grabbing":"ready"===t.status?"grab":"default"})))(W.puzzle))(W.ui)};Y.addEventListener("pan",(e=>{e.preventDefault();const{detail:{scale:t,position:n}}=e;W.ui.zoom=t,W.ui.position=n,W.ui.ctx.setTransform(t,0,0,t,n.x,n.y),J()})),setTimeout((()=>{E(W)}));const q=({x:e,y:t})=>{const[n,o]=(({x:e,y:t},n=Math.min(2,window.devicePixelRatio))=>[(e*n-M.x)/b,(t*n-M.y)/b])({x:e,y:t});return{x:n/W.ui.width,y:o/W.ui.height}};return W.ui.canvas.addEventListener("pointerdown",(({offsetX:e,offsetY:t})=>{const i=q({x:e,y:t});W.puzzle=o((({x:e,y:t})=>i=>{return{...i,pieces:o(p(((n,o,s,a)=>{return{...n,active:!(a.find((c="active",e=>e[c]))||!u(n,{x:e,y:t,width:1/i.size.x,height:1/i.size.y}))&&f(n,{x:e,y:t})};var c})),p(((n,o,i)=>({...n,active:i.find((e=>e.active&&e.connections.includes(n.id)))?f(n,{x:e,y:t}):n.active}))),n((s=l,e=>e.sort(s)))((e=>!i.done&&e.filter((e=>e.active)).length!==i.pieces.length)))(i.pieces)};var s})(i),z(i))(W.puzzle),J()})),W.ui.canvas.addEventListener("pointermove",(({offsetX:e,offsetY:t})=>{const n=q({x:e,y:t});W.puzzle=o((({x:e,y:t})=>n=>({...n,pieces:"idle"===n.status?n.pieces:n.pieces.map((n=>({...n,pos:n.active?{x:e-n.active.x,y:t-n.active.y}:n.pos})))}))(n),z(n))(W.puzzle),J()})),W.ui.canvas.addEventListener("pointerup",(({offsetX:e,offsetY:t})=>{const n=q({x:e,y:t});W.puzzle=o(v,m,w,z(n))(W.puzzle),J(),C({ui:W.ui,puzzle:i(W.puzzle)}),W.puzzle.done&&I(W)})),window.addEventListener("resize",(()=>{const{zoom:e,position:t}=W.ui;T(W.ui.canvas),P.setTransform(e,0,0,e,t.x,t.y),J()})),{newGame:()=>{W.puzzle=o(x(h))(R),J()},getState:()=>({ui:W.ui,puzzle:i(W.puzzle)}),setState:e=>{W.puzzle=o(x(h))(e.puzzle),J()},destroy:()=>{"CANVAS"!==t.tagName&&W.ui.canvas.remove(),W=null},setZoom:k,getZoom:()=>W.ui.zoom,restorePan:V}};

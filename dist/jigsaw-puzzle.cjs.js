"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const e=e=>t=>(e(t),t),t=(e=Math.random())=>.5*(Math.cos(6669.1337*Math.sin(1337.1337*(e+69)))+1),i=e=>t=>i=>("function"==typeof t?t(i):t)?e(i):i,o=(...e)=>t=>[...e].reduce(((e,t)=>t(e)),t),n=(e,t,i)=>{const o=e+1,n={top:o>i?e-i:void 0,right:o%i!=0?e+1:void 0,bottom:o<=(t-1)*i?e+i:void 0,left:o%i!=(i>1?1:0)?e-1:void 0};return JSON.parse(JSON.stringify(n))},s=e=>[...new Set(e)],a=(e,t)=>t.active?-1:1,c=e=>t=>t.reduceRight(((t,i,o,n)=>[...t,e(i,o,n,t)]),[]);function r(e){const t=[...e];let i=t.length;for(;i>0;){let e=Math.floor(Math.random()*i);i--;let o=t[i];t[i]=t[e],t[e]=o}return t}const d=e=>Math.random()*(e- -1*e)+-1*e,p=(e=!1)=>i=>(console.log(i.pieces.map(((e,t)=>t%i.size.x/i.size.x))),{...i,pieces:e?r(i.pieces).map(((e,t)=>({...e,connections:[],pos:{x:t%i.size.x/i.size.x*2-.42+d(.07),y:Math.floor(t/i.size.x)/i.size.y*2-.42+d(.07)}}))):i.pieces.map((e=>({...e,connections:[],pos:{x:2*t()-.5,y:2*t()-.5}})))}),l=(e,{x:t,y:i,width:o,height:n})=>t>=e.pos.x&&t<=e.pos.x+o&&i>=e.pos.y&&i<=e.pos.y+n,h=(e,{x:t,y:i})=>({x:t-e.pos.x,y:i-e.pos.y}),y=e((e=>{e.pieces=e.pieces.map((e=>({...e,active:!1})))}));let x=1;const u={x:window.innerWidth/2,y:window.innerHeight/2},f=({x:e,y:t,bounding:i={x:1/0,y:1/0}})=>(u.x=u.x+e,u.y=u.y+t,{position:u,scale:x}),m=({focal:e,zoom:t,max:i=1e4,min:o=.05})=>{const n=x===i||x===o;x=((e,t,i)=>Math.max(t,Math.min(i,e)))(x*t,o,i);const s=n?u.x:e.x,a=n?u.y:e.y;return u.x=s-(s-u.x)*t,u.y=a-(a-u.y)*t,{position:u,scale:x}};var g=(e,{dpi:t=Math.min(2,window.devicePixelRatio),bounding:i=null,initScale:o=1}={})=>{e.style.touchAction="none",e.style.userSelect="none",e.style.webkitUserSelect="none",e.style.overscrollBehaviour="contain";let n={},s=null;x=o;const a=t=>{e.dispatchEvent(new CustomEvent("pan",{detail:t,bubbles:!0,cancelable:!0,composed:!1}))};setTimeout((()=>a({scale:x,position:u})));const c=t=>{t.preventDefault(),n[t.pointerId]={x:t.offsetX,y:t.offsetY,deltaX:0,deltaY:0},e.addEventListener("pointerleave",d,{once:!0})},r=e=>{if(e.preventDefault(),!n[e.pointerId])return;if(2!==Object.keys(n).length)return;n[e.pointerId]={x:e.offsetX,y:e.offsetY,deltaX:e.offsetX-n[e.pointerId].x,deltaY:e.offsetY-n[e.pointerId].y};const i=Object.values(n),o=Math.sqrt(Math.pow(i[1].x-i[0].x,2)+Math.pow(i[1].y-i[0].y,2)),{position:c}=f({x:n[e.pointerId].deltaX*t*.7,y:n[e.pointerId].deltaY*t*.7}),{scale:r}=m({focal:{x:e.offsetX*t,y:e.offsetY*t},zoom:s?1+(o-s)/200:1});s=o,a({scale:r,position:c})},d=e=>{e.preventDefault(),delete n[e.pointerId],s=null};return"ontouchstart"in window||navigator.maxTouchPoints>0||navigator.msMaxTouchPoints>0?(e.addEventListener("pointerdown",c),e.addEventListener("pointermove",r),e.addEventListener("pointerup",d),e.addEventListener("pointercancel",d)):e.addEventListener("wheel",(e=>{e.preventDefault(),e.ctrlKey?a(m({focal:{x:e.offsetX*t,y:e.offsetY*t},zoom:1-e.deltaY/100})):a(f({x:-e.deltaX,y:-e.deltaY}))})),{zoom:e=>{m({focal:{x:window.innerWidth/2*t,y:window.innerHeight/2*t},zoom:e}),a({scale:x,position:u})},restore:()=>{u.x=window.innerWidth/2*Math.min(2,window.devicePixelRatio),u.y=window.innerHeight/2*Math.min(2,window.devicePixelRatio),a({scale:x,position:u})}}};const v=["top","right","bottom","left"],w=e=>"top"===e||"bottom"===e,z=(e,t)=>i=>i[e]===t,b=e((e=>{const t=e.pieces.filter((e=>e.active)),{width:i,height:o,size:n}=e;t.length&&t.length!==e.pieces.length&&t.forEach((t=>{Object.entries(t.neighbors).forEach((([i,o])=>{const a=e.pieces.find(z("id",o));if(((e,t,i,o)=>{const{attraction:n,size:s}=i,a=n/100,c=w(o)?"y":"x",r="x"===c?"y":"x",d=!(e=>"top"===e||"left"===e)(o),p="y"===c?1/s.y:1/s.x,l=d?t.pos[c]+p:t.pos[c]-p;return e.pos[c]<=l+a&&e.pos[c]>=l-a&&e.pos[r]<=t.pos[r]+a&&e.pos[r]>=t.pos[r]-a})(a,t,e,i)){const o={x:a.pos.x+("right"===i?-1/n.x:"left"===i?1/n.x:0),y:a.pos.y+("top"===i?1/n.y:"bottom"===i?-1/n.y:0)};((e,[...t],i)=>{t.forEach((t=>{const o=e.pieces.find(z("id",t));o.pos={x:o.pos.x+i.x,y:o.pos.y+i.y}}))})(e,t.connections,{x:o.x-t.pos.x,y:o.y-t.pos.y}),t.pos=o,((e,t,i)=>{t.connections=s([t.id,i.id,...t.connections,...i.connections]),t.connections.forEach((i=>{const o=e.pieces.find((e=>e.id===i));o.connections=s(t.connections)})),i.connections.forEach((i=>{const o=e.pieces.find((e=>e.id===i));o.connections=s(t.connections)}))})(e,t,a)}}))}))})),M=e((e=>{"active"===e.status&&(e.moves=e.moves+1),e.pieces[0].connections.length!==e.size.y*e.size.x||e.done||(e.done=!0)})),E=e=>JSON.parse(JSON.stringify(e)),I=({x:t,y:i})=>e((e=>{const o=e.pieces.find((e=>e.active));if(o)return void(e.status="active");!e.pieces.find((o=>l(o,{x:t,y:i,width:1/e.size.x,height:1/e.size.y})))||o?e.status="idle":e.status="ready"}));(()=>{if(!function(){const e=document.createElement("canvas").getContext("2d");e.fillRect(0,0,40,40),e.drawImage(e.canvas,-40,-40,80,80,50,50,20,20);const t=e.getImageData(50,50,30,30),i=new Uint32Array(t.data.buffer),o=(e,o)=>i[o*t.width+e];return[[9,9],[20,9],[9,20],[20,20]].some((([e,t])=>0!==o(e,t)))||[[10,10],[19,10],[10,19],[19,19]].some((([e,t])=>0===o(e,t)))}())return;const e=CanvasRenderingContext2D.prototype,t=e.drawImage;function i(e,t,i,o,n,s,a,c,r){const{width:d,height:p}=function(e){const t=t=>{const i=globalThis[t];return i&&e instanceof i};if(t("HTMLImageElement"))return{width:e.naturalWidth,height:e.naturalHeight};if(t("HTMLVideoElement"))return{width:e.videoWidth,height:e.videoHeight};if(t("SVGImageElement"))throw new TypeError("SVGImageElement isn't yet supported as source image.","UnsupportedError");if(t("HTMLCanvasElement")||t("ImageBitmap"))return e}(e);o<0&&(t+=o,o=Math.abs(o)),n<0&&(i+=n,n=Math.abs(n)),c<0&&(s+=c,c=Math.abs(c)),r<0&&(a+=r,r=Math.abs(r));const l=Math.max(t,0),h=Math.min(t+o,d),y=Math.max(i,0),x=Math.min(i+n,p),u=c/o,f=r/n;return[e,l,y,h-l,x-y,t<0?s-t*u:s,i<0?a-i*f:a,(h-l)*u,(x-y)*f]}function o(e){return[3,4,7,8].some((t=>!e[t]))}t?e.drawImage=function(e,n,s){const a=9===arguments.length;if(!a)return t.apply(this,[...arguments]);const c=i(...arguments);return o(c)?void 0:t.apply(this,c)}:console.error("This script requires a basic implementation of drawImage")})();const S=(e=100,t=100)=>{const i=t/110,o=e/2;return[{cx1:0,cy1:0,cx2:o-20*i,cy2:4*i,ex:o-13*i,ey:0*i},{cx1:o-13*i,cy1:0*i,cx2:o-10*i,cy2:-2*i,ex:o-12*i,ey:-5*i},{cx1:o-12*i,cy1:-5*i,cx2:o-30*i,cy2:-30*i,ex:o,ey:-30*i},{cx1:o,cy1:-30*i,cx2:o- -30*i,cy2:-31*i,ex:o- -12*i,ey:-5*i},{cx1:o- -12*i,cy1:-5*i,cx2:o- -10*i,cy2:-2*i,ex:o- -13*i,ey:0*i},{cx1:o- -13*i,cy1:0*i,cx2:o- -20*i,cy2:4*i,ex:e,ey:0*i}]},C=(e,t=1)=>e.map(((e,i)=>({cx1:e.cx1*t,cy1:-1*e.cy1,cx2:e.cx2*t,cy2:-1*e.cy2,ex:e.ex*t,ey:-1*e.ey}))),T=(e,i)=>{const o=e.width/i.size.x,n=e.height/i.size.y;return i.pieces.reduce(((e,i)=>(o,n)=>{const s=(e,t)=>o.find((t=>t.id===e))?.shapes[{top:"bottom",right:"left",bottom:"top",left:"right"}[t]],a={...(({neighbors:e},i,o)=>Object.keys(e).reduce(((n,a)=>({[a]:s(e[a],a)?C(s(e[a],a)):t()>=.5?S(w(a)?i:o,Math.min(i,o)):C(S(w(a)?i:o,Math.min(i,o))),...n})),{}))(n,e,i),...(({neighbors:e})=>v.filter((t=>!Object.keys(e).includes(t))).reduce(((e,t)=>({[t]:"flat",...e})),{}))(n)};return[{id:n.id,shapes:a},...o]})(o,n),[])},L=e=>{const{height:t,width:i}=getComputedStyle(e.parentElement),o=Math.min(2,window.devicePixelRatio);e.width=parseInt(i,0)*o,e.height=parseInt(t,0)*o},Y=e((e=>{const{canvas:t,ctx:i}=e;i.save(),i.setTransform(1,0,0,1,0,0),i.clearRect(0,0,t.width,t.height),i.restore()})),P=t=>e((e=>{Y(e),t.pieces.map(X(t,e))})),X=(e,t)=>i=>{const o={x:i.pos.x*t.width,y:i.pos.y*t.height},n={x:1/e.size.x*t.width,y:1/e.size.y*t.height},{ctx:s,image:a}=t,c=Math.max(n.x,n.y);s.save(),s.beginPath(),s.translate(o.x,o.y+n.y),v.forEach((e=>{!function(e,t,i){e.translate(0,i.x),"flat"===t?e.lineTo(i.y,0):t.forEach((t=>{e.bezierCurveTo(t.cx1,t.cy1,t.cx2,t.cy2,t.ex,t.ey)}));e.rotate(Math.PI/2)}(s,t.pieces.find((({id:e})=>e===i.id)).shapes[e],{x:"top"===e||"bottom"===e?-n.y:-n.x,y:"top"===e||"bottom"===e?n.x:n.y})})),s.closePath(),s.clip(),s.drawImage(a,i.origin.x*n.x-c,i.origin.y*n.y-c,n.x+2*c,n.y+2*c,i.pos.x/t.width-c,i.pos.y/t.height-c-n.y,n.x+2*c,n.y+2*c),s.restore();const r=!e.done&&(i.active||i.alsoActive),d=4e-4*t.width;s.shadowColor=r?"rgba(100, 100, 100, 1)":"rgba(50, 50, 50, 1)",s.strokeStyle=r?"rgba(225, 225, 225, 1)":"rgba(220, 220, 220, 1)",s.shadowBlur=r?2*d:d,s.lineWidth=r?2*d:d,s.shadowOffsetX=s.shadowOffsetY=-1,s.lineCap="round",s.lineJoin="round",s.stroke()};exports.puzzle=async({element:t,image:s="",pieces:r={x:6,y:4},attraction:d=5,aligned:f=!1,zoom:m,beforeInit:v=(()=>{}),onInit:w=(()=>{}),onComplete:z=(()=>{}),onChange:S=(()=>{})})=>{const C="string"==typeof t?document.querySelector(t):t;if(!C)return void console.warn(`Couldn't find element: ${t}`);const{canvas:Y,ctx:X}=(e=>{const t=e&&"CANVAS"===e.tagName?e:document.createElement("canvas"),i=t.getContext("2d");return e&&"CANVAS"!==e.tagName&&(e.appendChild(t),t.style.width="100%",t.style.height="100%",L(t)),{canvas:t,ctx:i}})(C);v(Y);const{image:O,width:A,height:N}=await(H=s,new Promise((e=>{var t=new Image;t.onload=()=>e({image:t,width:t.width,height:t.height}),t.src=H})));var H;const R={moves:0,status:"idle",done:!1,startTime:Date.now(),attraction:d,size:{x:r.x,y:r.y},pieces:(D=r,[...Array(D.y*D.x)].map(((e,t)=>({id:t,origin:{x:t%D.x,y:Math.floor(t/D.x)},pos:{x:0,y:0},neighbors:n(t,D.y,D.x),active:!1,connections:[]}))))};var D;const W={url:s,zoom:1,position:{x:0,y:0},canvas:Y,ctx:X,image:O,useCache:!1,height:N,width:A,pieces:T(O,R)};let j={};j.puzzle=o(p(f))(R),j.ui=P(j.puzzle)(W);const{zoom:k,restore:V}=g(Y,{initScale:m||Math.min(window.innerWidth/j.ui.width,window.innerHeight/j.ui.height)}),J=()=>{j.ui=o(P(j.puzzle),(t=>e((e=>{e.canvas.style.cursor="active"===t.status?"grabbing":"ready"===t.status?"grab":"default"})))(j.puzzle))(j.ui)};Y.addEventListener("pan",(e=>{e.preventDefault();const{detail:{scale:t,position:i}}=e;j.ui.zoom=t,j.ui.position=i,j.ui.ctx.setTransform(t,0,0,t,i.x,i.y),J()})),setTimeout((()=>{w(j)}));const q=({x:e,y:t})=>{const[i,o]=(({x:e,y:t},i=Math.min(2,window.devicePixelRatio))=>[(e*i-u.x)/x,(t*i-u.y)/x])({x:e,y:t});return{x:i/j.ui.width,y:o/j.ui.height}};return j.ui.canvas.addEventListener("pointerdown",(({offsetX:e,offsetY:t})=>{const n=q({x:e,y:t});j.puzzle=o((({x:e,y:t})=>n=>{return{...n,pieces:o(c(((i,o,s,a)=>{return{...i,active:!(a.find((c="active",e=>e[c]))||!l(i,{x:e,y:t,width:1/n.size.x,height:1/n.size.y}))&&h(i,{x:e,y:t})};var c})),c(((i,o,n)=>({...i,active:n.find((e=>e.active&&e.connections.includes(i.id)))?h(i,{x:e,y:t}):i.active}))),i((s=a,e=>e.sort(s)))((e=>!n.done&&e.filter((e=>e.active)).length!==n.pieces.length)))(n.pieces)};var s})(n),I(n))(j.puzzle),J()})),j.ui.canvas.addEventListener("pointermove",(({offsetX:e,offsetY:t})=>{const i=q({x:e,y:t});j.puzzle=o((({x:e,y:t})=>i=>({...i,pieces:"idle"===i.status?i.pieces:i.pieces.map((i=>({...i,pos:i.active?{x:e-i.active.x,y:t-i.active.y}:i.pos})))}))(i),I(i))(j.puzzle),J()})),j.ui.canvas.addEventListener("pointerup",(({offsetX:e,offsetY:t})=>{const i=q({x:e,y:t});j.puzzle=o(b,y,M,I(i))(j.puzzle),J(),S({ui:j.ui,puzzle:E(j.puzzle)}),j.puzzle.done&&z(j)})),window.addEventListener("resize",(()=>{const{zoom:e,position:t}=j.ui;L(j.ui.canvas),X.setTransform(e,0,0,e,t.x,t.y),J()})),{newGame:()=>{j.puzzle=o(p(f))(R),J()},getState:()=>({ui:j.ui,puzzle:E(j.puzzle)}),setState:e=>{j.puzzle=o(p(f))(e.puzzle),J()},destroy:()=>{"CANVAS"!==t.tagName&&j.ui.canvas.remove(),j=null},setZoom:k,getZoom:()=>j.ui.zoom,restorePan:V}};

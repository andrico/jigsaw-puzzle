const e=(...e)=>t=>[...e].reduce(((e,t)=>t(e)),t),t=e=>t=>(e(t),t),c=(e,t,c)=>{const n=c;return t.addEventListener(e,c),{remove:()=>t.removeEventListener(e,n)}},n=e=>({scroll:e=>c("scroll",window,e),resize:e=>c("resize",window,e),click:t=>c("click",e.element,t),mousedown:t=>c("mousedown",e.element,t),mousemove:t=>c("mousemove",e.element,t),mouseup:e=>c("mouseup",document.body,e)}),o=e=>{const{top:t,left:c}=e.canvas.element.getBoundingClientRect();return e.canvas.pos={x:c,y:t},e},a=e=>t=>t[e],s=(e,t)=>c=>c[e]===t,i=(e,t,c)=>{const n=e+1;return(e=>{let t={};return Object.keys(e).forEach((c=>{null!==e[c]&&(t[c]=e[c])})),t})({top:n>c?e-c:null,right:n%c!=0?e+1:null,bottom:n<=(t-1)*c?e+c:null,left:n%c!=1?e-1:null})},r=["top","right","bottom","left"],h=e=>"top"===e||"bottom"===e,l=(e=100,t=100)=>{const c=t/110,n=e/2;return[{cx1:0,cy1:0,cx2:n-10*c,cy2:5*c,ex:n-13*c,ey:0*c},{cx1:n-13*c,cy1:0*c,cx2:n-10*c,cy2:-2*c,ex:n-12*c,ey:-5*c},{cx1:n-12*c,cy1:-5*c,cx2:n-30*c,cy2:-30*c,ex:n,ey:-30*c},{cx1:n,cy1:-30*c,cx2:n- -30*c,cy2:-31*c,ex:n- -12*c,ey:-5*c},{cx1:n- -12*c,cy1:-5*c,cx2:n- -10*c,cy2:-2*c,ex:n- -13*c,ey:0*c},{cx1:n- -13*c,cy1:0*c,cx2:n- -10*c,cy2:5*c,ex:e,ey:0*c}]},u=(e,t=1)=>e.map(((e,c)=>({cx1:e.cx1*t,cy1:-1*e.cy1,cx2:e.cx2*t,cy2:-1*e.cy2,ex:e.ex*t,ey:-1*e.ey}))),d=(e=Math.random())=>.5*(Math.cos(6669.1337*Math.sin(1337.1337*(e+69)))+1),g=(e,t)=>{const c=t=>e.find((e=>e.id===t)),n=(e,t)=>c(e)&&c(e).shapes&&c(e).shapes[(e=>({top:"bottom",right:"left",bottom:"top",left:"right"}[e]))(t)],o={...(({neighbors:e,width:t,height:c})=>Object.keys(e).reduce(((o,a)=>({[a]:n(e[a],a)?u(n(e[a],a)):d()>=.5?l(h(a)?t:c,Math.min(t,c)):u(l(h(a)?t:c,Math.min(t,c))),...o})),{}))(t),...(({neighbors:e})=>r.filter((t=>!Object.keys(e).includes(t))).reduce(((e,t)=>({[t]:"flat",...e})),{}))(t)};return[{...t,shapes:o},...e]};function p(e){const t=[...e];let c=t.length;for(;c>0;){let e=Math.floor(Math.random()*c);c--;let n=t[c];t[c]=t[e],t[e]=n}return t}const v=e=>({...e,pieces:e.puzzle.aligned?p(e.pieces).map(((t,c)=>({...t,connections:[],curPos:{x:c%e.puzzle.cols*e.pieces[0].width*1.5,y:Math.floor(c/e.puzzle.cols)*e.pieces[0].height*1.5}}))):e.pieces.map(((t,c)=>({...t,connections:[],curPos:{x:d()*(e.canvas.width-e.pieces[0].width),y:d()*(e.canvas.height-e.pieces[0].height)}})))}),m=e=>[...new Set(e)],y=(e,t)=>t.active?-1:1,x=e=>t=>t.map(e),w=e=>t=>t.reduceRight(((t,c,n,o)=>[...t,e(c,n,o,t)]),[]),f=(e,t)=>c=>{const{image:n}=e.image,{ctx:o,DPI:a=2}=t||e.canvas,{scale:s,occupy:i}=e.puzzle,h=Math.max(c.width,c.height);o.save(),o.beginPath(),o.translate(c.curPos.x,c.curPos.y+c.height),r.forEach((e=>{!function(e,t,c){e.translate(0,c.x),"flat"===t?e.lineTo(c.y,0):t.forEach((t=>{e.bezierCurveTo(t.cx1,t.cy1,t.cx2,t.cy2,t.ex,t.ey)}));e.rotate(Math.PI/2)}(o,c.shapes[e],{x:"top"===e||"bottom"===e?-c.height:-c.width,y:"top"===e||"bottom"===e?c.width:c.height})})),o.closePath(),o.clip(),o.drawImage(n,(c.orgPos.x-h)/s/a/i,(c.orgPos.y-h)/s/a/i,(c.width+2*h)/s/a/i,(c.height+2*h)/s/a/i,c.curPos.x/e.canvas.width-h,c.curPos.y/e.canvas.height-h-c.height,c.width+2*h,c.height+2*h),o.restore();const l=!e.puzzle.done&&(c.active||c.alsoActive);o.shadowColor=l?"rgba(100, 100, 100, 1)":"rgba(50, 50, 50, 1)",o.strokeStyle=l?"rgba(225, 225, 225, 1)":"rgba(220, 220, 220, 1)",o.shadowBlur=l?2:1,o.lineWidth=l?2:1,o.shadowOffsetX=o.shadowOffsetY=-1,o.lineCap="round",o.lineJoin="round",o.stroke()};const P=(e,t)=>(t.clearRect(0,0,e.canvas.width,e.canvas.height),t),b=t((e=>{P(e,e.canvas.ctx),(e=>{e.canvas.ctx.drawImage(e.canvas.background.canvas,0,0);const t=e.pieces.filter((({active:e})=>e));x(f(e))(t)})(e)})),z=e=>t=>c=>("function"==typeof t?t(c):t)?e(c):c,I=(e,t,c)=>((e,t,c)=>(c.clientX-e.canvas.pos.x)*e.canvas.DPI>=t.curPos.x&&(c.clientX-e.canvas.pos.x)*e.canvas.DPI<=t.curPos.x+t.width)(e,t,c)&&((e,t,c)=>(c.clientY-e.canvas.pos.y)*e.canvas.DPI>=t.curPos.y&&(c.clientY-e.canvas.pos.y)*e.canvas.DPI<=t.curPos.y+t.height)(e,t,c),C=(e,t,c)=>({x:(c.clientX-e.canvas.pos.x)*e.canvas.DPI-t.curPos.x,y:(c.clientY-e.canvas.pos.y)*e.canvas.DPI-t.curPos.y}),M=e=>({...e,pieces:e.pieces.map((e=>({...e,active:!1})))}),E=e=>{const t=e.pieces.filter((e=>e.active));return t.length&&t.length!==e.pieces.length?(t.forEach((t=>{Object.entries(t.neighbors).forEach((([c,n])=>{const o=e.pieces.find(s("id",n));if(((e,t,c,n)=>{const{attraction:o}=c.puzzle,a=h(n)?"y":"x",s="x"===a?"y":"x",i=!(e=>"top"===e||"left"===e)(n),r=e["y"===a?"height":"width"],l=i?t.curPos[a]+r:t.curPos[a]-r;return e.curPos[a]<=l+o&&e.curPos[a]>=l-o&&e.curPos[s]<=t.curPos[s]+o&&e.curPos[s]>=t.curPos[s]-o})(o,t,e,c)){const n={x:o.curPos.x+("right"===c?-o.width:"left"===c?+o.width:0),y:o.curPos.y+("top"===c?o.height:"bottom"===c?-o.height:0)};((e,[...t],c)=>{t.forEach((t=>{const n=e.pieces.find(s("id",t));n.curPos={x:n.curPos.x+c.x,y:n.curPos.y+c.y}}))})(e,t.connections,{x:n.x-t.curPos.x,y:n.y-t.curPos.y}),t.curPos=n,((e,t,c)=>{t.connections=m([t.id,c.id,...t.connections,...c.connections]),t.connections.forEach((c=>{const n=e.pieces.find((e=>e.id===c));n.connections=m(t.connections)})),c.connections.forEach((c=>{const n=e.pieces.find((e=>e.id===c));n.connections=m(t.connections)}))})(e,t,o)}}))})),e):e},D=e=>(e.pieces[0].connections.length!==e.puzzle.rows*e.puzzle.cols||e.puzzle.done||(e.puzzle.done=!0,e.puzzle.onComplete(e)),e),S=e=>(e.pieces=e.pieces.map((t=>({...t,curPos:{x:t.curPos.x-t.width>e.canvas.width*e.canvas.DPI?e.canvas.width-t.width:t.curPos.x,y:t.curPos.y-t.height>e.canvas.height*e.canvas.DPI?e.canvas.height-t.height:t.curPos.y}}))),e),k=e=>({image:e.image,canvas:e.canvas,pieces:JSON.parse(JSON.stringify(e.pieces)),puzzle:JSON.parse(JSON.stringify(e.puzzle))}),N=t((e=>{e.canvas.background.ctx=P(e,e.canvas.background.ctx),e.canvas.foreground.ctx=P(e,e.canvas.foreground.ctx),x(f(e,{ctx:e.canvas.background.ctx}))(e.pieces.filter((({active:e})=>!e))),x(f(e,{ctx:e.canvas.foreground.ctx}))(e.pieces.filter((({active:e})=>e)))})),O=e=>t((t=>{const c=t.pieces.find((c=>I(t,c,e))),n=t.pieces.find((e=>e.active)),o=t.pieces.every((e=>e.active));!n||o?!c||n?t.puzzle.draggable&&(t.canvas.cursor="move"):t.canvas.cursor="grab":t.canvas.cursor="grabbing"})),A=t((e=>{e.canvas.element.style.cursor=e.canvas.cursor}));(()=>{if(!function(){const e=document.createElement("canvas").getContext("2d");e.fillRect(0,0,40,40),e.drawImage(e.canvas,-40,-40,80,80,50,50,20,20);const t=e.getImageData(50,50,30,30),c=new Uint32Array(t.data.buffer),n=(e,n)=>c[n*t.width+e];return[[9,9],[20,9],[9,20],[20,20]].some((([e,t])=>0!==n(e,t)))||[[10,10],[19,10],[10,19],[19,19]].some((([e,t])=>0===n(e,t)))}())return;const e=CanvasRenderingContext2D.prototype,t=e.drawImage;function c(e,t,c,n,o,a,s,i,r){const{width:h,height:l}=function(e){const t=t=>{const c=globalThis[t];return c&&e instanceof c};if(t("HTMLImageElement"))return{width:e.naturalWidth,height:e.naturalHeight};if(t("HTMLVideoElement"))return{width:e.videoWidth,height:e.videoHeight};if(t("SVGImageElement"))throw new TypeError("SVGImageElement isn't yet supported as source image.","UnsupportedError");if(t("HTMLCanvasElement")||t("ImageBitmap"))return e}(e);n<0&&(t+=n,n=Math.abs(n)),o<0&&(c+=o,o=Math.abs(o)),i<0&&(a+=i,i=Math.abs(i)),r<0&&(s+=r,r=Math.abs(r));const u=Math.max(t,0),d=Math.min(t+n,h),g=Math.max(c,0),p=Math.min(c+o,l),v=i/n,m=r/o;return[e,u,g,d-u,p-g,t<0?a-t*v:a,c<0?s-c*m:s,(d-u)*v,(p-g)*m]}function n(e){return[3,4,7,8].some((t=>!e[t]))}t?e.drawImage=function(e,o,a){const s=9===arguments.length;if(!s)return t.apply(this,[...arguments]);const i=c(...arguments);return n(i)?void 0:t.apply(this,i)}:console.error("This script requires a basic implementation of drawImage")})();const R=async({element:c,restore:s={},image:r="",pieces:h={x:6,y:4},attraction:l=20,size:u=.8,draggable:d=!1,aligned:p=!1,onComplete:m=(()=>{}),onChange:x=(()=>{})})=>{const f="string"==typeof c?document.querySelector(c):c;if(!f)return void console.warn(`Couldn't find element: ${c}`);const P=(e=>{const t=window.devicePixelRatio,c="CANVAS"===e.tagName?e:document.createElement("canvas"),n=c.getContext("2d"),o=document.createElement("canvas"),a=document.createElement("canvas"),{height:s,width:i}=getComputedStyle(e);c.width=o.width=a.width=parseInt(i,0)*t,c.height=o.height=a.height=parseInt(s,0)*t,c.style.width=o.style.width=a.style.width=parseInt(i,0)+"px",c.style.height=o.style.height=a.style.height=parseInt(s,0)+"px","CANVAS"!==e.tagName&&e.appendChild(c);const{top:r,left:h}=c.getBoundingClientRect();return{element:c,background:{canvas:o,ctx:o.getContext("2d")},foreground:{canvas:a,ctx:a.getContext("2d"),pos:{x:null,y:null}},ctx:n,pos:{x:h,y:r},width:c.width,height:c.height,DPI:t}})(f),R=s.image||await(T=r,new Promise((e=>{var t=new Image;t.onload=()=>e({image:t,width:t.width,height:t.height}),t.src=T})));var T;const V=()=>s.puzzle||((e,t,c,n,o,a,s,i)=>{const{width:r,height:h}=getComputedStyle(n),l=t.width<t.height,u=window.devicePixelRatio,d=parseInt([l?h:r],0)/t[l?"height":"width"];return{timeStamp:Date.now(),done:!1,cols:e.x,rows:e.y,width:t.width*d*u,height:t.height*d*u,attraction:c,scale:d,occupy:o,draggable:a,aligned:s,onComplete:i}})(h,R,l,f,u,d,p,m),X=s.pieces||(e=>{const t=[...Array(e.rows*e.cols)],c=e.width/e.cols*e.occupy,n=e.height/e.rows*e.occupy;return t.map(((t,o)=>({id:o,orgPos:{x:o%e.cols*c,y:Math.floor(o/e.cols)*n},curPos:{x:0,y:0},width:c,height:n,neighbors:i(o,e.rows,e.cols),active:!1,connections:[]}))).reduce(g,[])})(V()),Y="function"==typeof x&&t(e(k,x)),H=()=>({image:R,canvas:P,pieces:X,puzzle:V()});let J=H();J=s.puzzle?e(b)(J):e(v,N,b)(J);const L=[n(window).resize((t=>J=e(o,S,b)(J))),n(window).scroll((t=>J=e(o)(J))),n(J.canvas).mousedown((t=>J=e((t=>c=>{return{...c,pieces:e(w(((e,n,o,s)=>({...e,active:!(s.find(a("active"))||!I(c,e,t))&&C(c,e,t)}))),w(((e,n,o)=>({...e,active:o.find((t=>t.active&&t.connections.includes(e.id)))||!o.find(a("active"))&&c.puzzle.draggable?C(c,e,t):e.active}))),z((n=y,e=>e.sort(n)))((e=>!c.puzzle.done&&e.filter((e=>e.active)).length!==c.pieces.length)))(c.pieces)};var n})(t),O(t),A,N,b)(J))),n(J.canvas).mousemove((c=>{J=e(O(c),(({clientX:e,clientY:t})=>c=>({...c,pieces:c.pieces.map((n=>({...n,curPos:n.active?{x:(e-c.canvas.pos.x)*c.canvas.DPI-n.active.x,y:(t-c.canvas.pos.y)*c.canvas.DPI-n.active.y}:n.curPos})))}))(c),(({clientX:e,clientY:c})=>t((t=>{t.canvas.foreground.pos={x:(e-t.canvas.pos.x)*t.canvas.DPI-t.canvas.foreground.pos.x,y:(c-t.canvas.pos.y)*t.canvas.DPI-t.canvas.foreground.pos.y}})))(c),b,A)(J)})),n(document.body).mouseup((t=>J=e(E,M,N,O(t),b,A,Y,D)(J)))];return{newGame:()=>J=e(v,b)(H()),getState:()=>k(J),setState:t=>J=e(k,b)(t),update:()=>J=e(o,b)(J),destroy:()=>{"CANVAS"!==c.tagName&&J.canvas.element.remove(),J=null,L.map((e=>e.remove()))}}};export{R as puzzle};

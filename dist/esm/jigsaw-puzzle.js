const e=e=>t=>(e(t),t),t=(e=Math.random())=>.5*(Math.cos(6669.1337*Math.sin(1337.1337*(e+69)))+1),n=e=>t=>n=>("function"==typeof t?t(n):t)?e(n):n,i=(...e)=>t=>[...e].reduce(((e,t)=>t(e)),t),o=e=>JSON.parse(JSON.stringify(e)),s=(e,t,n)=>{const i=e+1,o={top:i>n?e-n:void 0,right:i%n!=0?e+1:void 0,bottom:i<=(t-1)*n?e+n:void 0,left:i%n!=(n>1?1:0)?e-1:void 0};return JSON.parse(JSON.stringify(o))},a=["top","right","bottom","left"],r=({shape:e,size:t})=>(console.log(e,t),{shape:"out"===e?"in":"out",size:t}),c=["top","right","bottom","left"],d=(e,t)=>c.indexOf(e[0])>c.indexOf(t[0])?1:-1,l=(e,n)=>[...Array(e.y*e.x)].map(((t,n)=>({id:n,origin:{x:n%e.x,y:Math.floor(n/e.x)},pos:{x:0,y:0},neighbors:s(n,e.y,e.x),active:!1,connections:[]}))).reduce((e=>(n,i)=>{const o=(e,t)=>n.find((t=>t.id===e))?.sides[{top:"bottom",right:"left",bottom:"top",left:"right"}[t]],s=[...Object.entries({...(({neighbors:n})=>Object.keys(n).reduce(((i,s)=>{const a=o(n[s],s);return{[s]:a?r(a):t()>=.5?{shape:"out",size:e?Math.random():1}:{shape:"in",size:e?Math.random():1},...i}}),{}))(i),...(({neighbors:e})=>a.filter((t=>!Object.keys(e).includes(t))).reduce(((e,t)=>({[t]:{shape:"flat",size:1},...e})),{}))(i)})].sort(d).reduce(((e,[t,n])=>({...e,[t]:n})),{});return[{...i,sides:s},...n]})(n),[]),p=e=>[...new Set(e)],h=(e,t)=>t.active?-1:1,u=e=>t=>t.reduceRight(((t,n,i,o)=>[...t,e(n,i,o,t)]),[]);function x(e){const t=[...e];let n=t.length;for(;n>0;){let e=Math.floor(Math.random()*n);n--;let i=t[n];t[n]=t[e],t[e]=i}return t}const y=e=>Math.random()*(e- -1*e)+-1*e,m=(e=!1)=>n=>({...n,pieces:e?x(n.pieces).map(((e,t)=>({...e,connections:[],pos:{x:t%n.size.x/n.size.x*2-.4+y(.03),y:Math.floor(t/n.size.x)/n.size.y*2-.4+y(.03)}}))):n.pieces.map((e=>({...e,connections:[],pos:{x:2*t()-.5,y:2*t()-.5}})))}),f=(e,{x:t,y:n,width:i,height:o})=>t>=e.pos.x&&t<=e.pos.x+i&&n>=e.pos.y&&n<=e.pos.y+o,g=(e,{x:t,y:n})=>({x:t-e.pos.x,y:n-e.pos.y}),v=e((e=>{e.pieces=e.pieces.map((e=>({...e,active:!1})))})),z=(e,t)=>n=>n[e]===t,w=e((e=>{const t=e.pieces.filter((e=>e.active)),{size:n}=e;t.length&&t.length!==e.pieces.length&&t.forEach((t=>{Object.entries(t.neighbors).forEach((([i,o])=>{const s=e.pieces.find(z("id",o));if(((e,t,n,i)=>{const{attraction:o,size:s}=n,a=o/100,r=(e=>"top"===e||"bottom"===e)(i)?"y":"x",c="x"===r?"y":"x",d=!(e=>"top"===e||"left"===e)(i),l="y"===r?1/s.y:1/s.x,p=d?t.pos[r]+l:t.pos[r]-l;return e.pos[r]<=p+a&&e.pos[r]>=p-a&&e.pos[c]<=t.pos[c]+a&&e.pos[c]>=t.pos[c]-a})(s,t,e,i)){const o={x:s.pos.x+("right"===i?-1/n.x:"left"===i?1/n.x:0),y:s.pos.y+("top"===i?1/n.y:"bottom"===i?-1/n.y:0)};((e,[...t],n)=>{t.forEach((t=>{const i=e.pieces.find(z("id",t));i.pos={x:i.pos.x+n.x,y:i.pos.y+n.y}}))})(e,t.connections,{x:o.x-t.pos.x,y:o.y-t.pos.y}),t.pos=o,((e,t,n)=>{t.connections=p([t.id,n.id,...t.connections,...n.connections]),t.connections.forEach((n=>{const i=e.pieces.find((e=>e.id===n));i.connections=p(t.connections)})),n.connections.forEach((n=>{const i=e.pieces.find((e=>e.id===n));i.connections=p(t.connections)}))})(e,t,s)}}))}))})),b=e((e=>{"active"===e.status&&(e.moves=e.moves+1),e.pieces[0].connections.length!==e.size.y*e.size.x||e.done||(e.done=!0)})),M=({x:t,y:n})=>e((e=>{const i=e.pieces.find((e=>e.active));if(i)return void(e.status="active");!e.pieces.find((i=>f(i,{x:t,y:n,width:1/e.size.x,height:1/e.size.y})))||i?e.status="idle":e.status="ready"}));(()=>{if(!function(){const e=document.createElement("canvas").getContext("2d");e.fillRect(0,0,40,40),e.drawImage(e.canvas,-40,-40,80,80,50,50,20,20);const t=e.getImageData(50,50,30,30),n=new Uint32Array(t.data.buffer),i=(e,i)=>n[i*t.width+e];return[[9,9],[20,9],[9,20],[20,20]].some((([e,t])=>0!==i(e,t)))||[[10,10],[19,10],[10,19],[19,19]].some((([e,t])=>0===i(e,t)))}())return;const e=CanvasRenderingContext2D.prototype,t=e.drawImage;function n(e,t,n,i,o,s,a,r,c){const{width:d,height:l}=function(e){const t=t=>{const n=globalThis[t];return n&&e instanceof n};if(t("HTMLImageElement"))return{width:e.naturalWidth,height:e.naturalHeight};if(t("HTMLVideoElement"))return{width:e.videoWidth,height:e.videoHeight};if(t("SVGImageElement"))throw new TypeError("SVGImageElement isn't yet supported as source image.","UnsupportedError");if(t("HTMLCanvasElement")||t("ImageBitmap"))return e}(e);i<0&&(t+=i,i=Math.abs(i)),o<0&&(n+=o,o=Math.abs(o)),r<0&&(s+=r,r=Math.abs(r)),c<0&&(a+=c,c=Math.abs(c));const p=Math.max(t,0),h=Math.min(t+i,d),u=Math.max(n,0),x=Math.min(n+o,l),y=r/i,m=c/o;return[e,p,u,h-p,x-u,t<0?s-t*y:s,n<0?a-n*m:a,(h-p)*y,(x-u)*m]}function i(e){return[3,4,7,8].some((t=>!e[t]))}t?e.drawImage=function(e,o,s){const a=9===arguments.length;if(!a)return t.apply(this,[...arguments]);const r=n(...arguments);return i(r)?void 0:t.apply(this,r)}:console.error("This script requires a basic implementation of drawImage")})();let E=1;const I={x:window.innerWidth/2,y:window.innerHeight/2},S=({x:e,y:t,bounding:n={x:1/0,y:1/0}})=>(I.x=I.x+e,I.y=I.y+t,{position:I,scale:E}),C=({focal:e,zoom:t,max:n=1e4,min:i=.05})=>{const o=E===n||E===i;E=((e,t,n)=>Math.max(t,Math.min(n,e)))(E*t,i,n);const s=o?I.x:e.x,a=o?I.y:e.y;return I.x=s-(s-I.x)*t,I.y=a-(a-I.y)*t,{position:I,scale:E}};var O=(e,{dpi:t=Math.min(2,window.devicePixelRatio),bounding:n=null,initScale:i=1}={})=>{e.style.touchAction="none",e.style.userSelect="none",e.style.webkitUserSelect="none",e.style.overscrollBehavior="contain";let o={},s=null;E=i;const a=t=>{e.dispatchEvent(new CustomEvent("pan",{detail:t,bubbles:!0,cancelable:!0,composed:!1}))};setTimeout((()=>a({scale:E,position:I})));const r=t=>{t.preventDefault(),o[t.pointerId]={x:t.offsetX,y:t.offsetY,deltaX:0,deltaY:0},e.addEventListener("pointerleave",d,{once:!0})},c=e=>{if(e.preventDefault(),!o[e.pointerId])return;o[e.pointerId]={x:e.offsetX,y:e.offsetY,deltaX:e.offsetX-o[e.pointerId].x,deltaY:e.offsetY-o[e.pointerId].y};const n=Object.values(o),{position:i}=S({x:o[e.pointerId].deltaX*t*.7,y:o[e.pointerId].deltaY*t*.7}),r=2!==Object.keys(o).length?1:Math.sqrt(Math.pow(n[1].x-n[0].x,2)+Math.pow(n[1].y-n[0].y,2)),{scale:c}=C({focal:{x:e.offsetX*t,y:e.offsetY*t},zoom:2===Object.keys(o).length&&s?1+(r-s)/200:1});s=r,a({scale:c,position:i})},d=e=>{e.preventDefault(),delete o[e.pointerId],s=null};return"ontouchstart"in window||navigator.maxTouchPoints>0||navigator.msMaxTouchPoints>0?(e.addEventListener("pointerdown",r),e.addEventListener("pointermove",c),e.addEventListener("pointerup",d),e.addEventListener("pointercancel",d)):e.addEventListener("wheel",(e=>{e.preventDefault(),e.ctrlKey?a(C({focal:{x:e.offsetX*t,y:e.offsetY*t},zoom:1-e.deltaY/100})):a(S({x:-e.deltaX,y:-e.deltaY}))})),{zoom:e=>{C({focal:{x:window.innerWidth/2*t,y:window.innerHeight/2*t},zoom:e}),a({scale:E,position:I})},restore:()=>{I.x=window.innerWidth/2*Math.min(2,window.devicePixelRatio),I.y=window.innerHeight/2*Math.min(2,window.devicePixelRatio),a({scale:E,position:I})}}};const T=[...Array(20)].map(((e,t)=>Math.floor(20*(1-t/20))/20));console.log(T);const L=e=>{const{height:t,width:n}=getComputedStyle(e.parentElement),i=Math.min(2,window.devicePixelRatio);e.width=parseInt(n,0)*i,e.height=parseInt(t,0)*i},Y=e((e=>{const{canvas:t,ctx:n}=e;n.save(),n.setTransform(1,0,0,1,0,0),n.clearRect(0,0,t.width,t.height),n.restore()})),P=t=>e((e=>{Y(e),t.pieces.map(X(t,e))})),X=(e,t)=>n=>{const i={x:t.size.x/e.size.x,y:t.size.y/e.size.y},{ctx:o,image:s}=t,a=t.shapes[n.id],r=Math.max(i.x,i.y);o.save(),o.translate(n.pos.x*t.size.x,n.pos.y*t.size.y);const c=!e.done&&(n.active||n.alsoActive),d=8/Math.max(t.zoom,4);o.lineWidth=c?2*d:d,o.shadowOffsetX=o.shadowOffsetY=-d/2,o.shadowBlur=d,o.shadowColor=c?"rgba(100, 100, 100, 1)":"rgba(50, 50, 50, 1)",o.stroke(a),o.clip(a),o.drawImage(s,n.origin.x*i.x-r,n.origin.y*i.y-r,i.x+r*t.dpi,i.y+r*t.dpi,n.pos.x/t.size.x-r,n.pos.y/t.size.y-r,i.x+r*t.dpi,i.y+r*t.dpi),o.restore()},k=(e,t,...n)=>{const i=t*Math.PI/180,{sin:o,cos:s}=Math;return n.map((([t,n])=>[(t-e.x)*s(i)-(n-e.y)*o(i)+e.x,(t-e.x)*o(i)+(n-e.y)*s(i)+e.y])).flat()},A=(e,t)=>{const[n]=e[0];return e.map((e=>k({x:n[0],y:n[1]},t,...e)))},R=(e,t)=>e.map((e=>e.map((e=>[e[0]+t.x,e[1]+t.y])))),N=({size:e,shapes:t,knobsize:n})=>{const i=new Path2D;if(4===!t.length)return void console.log("a piece needs to have 4 sides");return[{x:0,y:0,angle:0},{x:e.x,y:0,angle:90},{x:e.x,y:e.y,angle:180},{x:0,y:e.y,angle:270}].forEach(((o,s)=>{const a=s%2==1?e.y:e.x,r=t[s];if("flat"===r){const e=k(o,o.angle,[o.x+a,o.y]);i.lineTo(...e)}else{const e=(({knobsize:e=1,length:t=100})=>{const n=t/2;return[[[0,0],[n-20*e,4*e],[n-13*e,0]],[[n-13*e,0],[n-10*e,-2*e],[n-12*e,-5*e]],[[n-12*e,-5*e],[n-30*e,-30*e],[n,-30*e]],[[n,-30*e],[n- -30*e,-30*e],[n- -12*e,-5*e]],[[n- -12*e,-5*e],[n- -10*e,-2*e],[n- -13*e,0]],[[n- -13*e,0],[n- -20*e,4*e],[t,0]]]})({length:a,knobsize:n[s]});A(R("in"===r?(e=>e.map((e=>e.map((e=>[e[0],-1*e[1]])))))(e):e,o),o.angle).forEach((e=>i.bezierCurveTo(...e.flat())))}})),i.closePath(),i},D=(e,t,n)=>n.reduce(((n,i)=>{const o=Object.values(i.sides),s=o.map((({shape:e})=>e)),a=o.map((({size:n})=>(.6+.4*n)*Math.min(e,t)/110));return{...n,[i.id]:N({size:{x:e,y:t},shapes:s,knobsize:a})}}),{}),H=async({element:t,image:s="",pieces:a={x:6,y:4},attraction:r=5,aligned:c=!0,individualize:d=!1,zoom:p,beforeInit:x=(()=>{}),onInit:y=(()=>{}),onComplete:z=(()=>{}),onChange:S=(()=>{})})=>{const C="string"==typeof t?document.querySelector(t):t;if(!C)return void console.warn(`Couldn't find element: ${t}`);const{canvas:T,ctx:Y}=(e=>{const t=e&&"CANVAS"===e.tagName?e:document.createElement("canvas"),n=t.getContext("2d");return e&&"CANVAS"!==e.tagName&&(e.appendChild(t),t.style.width="100%",t.style.height="100%",L(t)),n.strokeStyle="rgba(220, 220, 220, 1)",n.lineCap="round",n.lineJoin="round",{canvas:t,ctx:n}})(C);x(T);const{image:X,width:k,height:A}=await(R=s,new Promise((e=>{const t=new Image;t.onload=()=>{e({image:t,width:t.width,height:t.height})},t.src=R})));var R;const N={moves:0,status:"idle",done:!1,startTime:Date.now(),attraction:r,size:a,pieces:l(a,d)},H={url:s,zoom:1,position:{x:0,y:0},size:{x:k,y:A},canvas:T,ctx:Y,image:X,dpi:Math.min(2,window.devicePixelRatio),shapes:D(k/a.x,A/a.y,N.pieces)};let j={};j.puzzle=i(m(c))(N),j.ui=P(j.puzzle)(H);const{zoom:W,restore:V}=O(T,{dpi:Math.min(2,window.devicePixelRatio),initScale:p||Math.min(window.innerWidth/j.ui.size.x*.9,window.innerHeight/j.ui.size.y*.9)}),J=()=>{j.ui=i(P(j.puzzle),(t=>e((e=>{e.canvas.style.cursor="active"===t.status?"grabbing":"ready"===t.status?"grab":"default"})))(j.puzzle))(j.ui)};T.addEventListener("pan",(e=>{e.preventDefault();const{detail:{scale:t,position:n}}=e;j.ui.zoom=t,j.ui.position=n,j.ui.ctx.setTransform(t,0,0,t,n.x,n.y),J()})),setTimeout((()=>y(j)));const q=({x:e,y:t})=>{const[n,i]=(({x:e,y:t},n=Math.min(2,window.devicePixelRatio))=>[(e*n-I.x)/E,(t*n-I.y)/E])({x:e,y:t},j.ui.dpi);return{x:n/j.ui.size.x,y:i/j.ui.size.y}};return j.ui.canvas.addEventListener("pointerdown",(({offsetX:e,offsetY:t})=>{const o=q({x:e,y:t});j.puzzle=i((({x:e,y:t})=>o=>{return{...o,pieces:i(u(((n,i,s,a)=>{return{...n,active:!(a.find((r="active",e=>e[r]))||!f(n,{x:e,y:t,width:1/o.size.x,height:1/o.size.y}))&&g(n,{x:e,y:t})};var r})),u(((n,i,o)=>({...n,active:o.find((e=>e.active&&e.connections.includes(n.id)))?g(n,{x:e,y:t}):n.active}))),n((s=h,e=>e.sort(s)))((e=>!o.done&&e.filter((e=>e.active)).length!==o.pieces.length)))(o.pieces)};var s})(o),M(o))(j.puzzle),J()})),j.ui.canvas.addEventListener("pointermove",(({offsetX:e,offsetY:t})=>{const n=q({x:e,y:t});j.puzzle=i((({x:e,y:t})=>n=>({...n,pieces:"idle"===n.status?n.pieces:n.pieces.map((n=>({...n,pos:n.active?{x:e-n.active.x,y:t-n.active.y}:n.pos})))}))(n),M(n))(j.puzzle),J()})),j.ui.canvas.addEventListener("pointerup",(({offsetX:e,offsetY:t})=>{const n=q({x:e,y:t});j.puzzle=i(w,v,b,M(n))(j.puzzle),J(),S({ui:j.ui,puzzle:o(j.puzzle)}),j.puzzle.done&&z(j)})),window.addEventListener("resize",(()=>{const{zoom:e,position:t}=j.ui;L(j.ui.canvas),Y.setTransform(e,0,0,e,t.x,t.y),J()})),{newGame:()=>{j.puzzle=i(m(c))(N),J()},getState:()=>o(j.puzzle),setState:e=>{j.puzzle=e,J()},destroy:()=>{"CANVAS"!==t.tagName&&j.ui.canvas.remove(),j=null},setZoom:W,getZoom:()=>j.ui.zoom,centralize:V}};export{H as puzzle};
